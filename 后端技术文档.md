# 后端技术文档

## **1. 技术选型**

| **类型** | **技术选型** | **说明** |
| --- | --- | --- |
| 运行时 | Node.js 18+ | JavaScript 运行时环境 |
| 语言 | TypeScript 5 | 类型安全，提高开发可维护性 |
| 框架 | Express.js | 轻量级 Web 框架 |
| 数据库 | Google Firestore | NoSQL 文档数据库，支持实时更新 |
| 认证 | Firebase Auth | 用户认证和授权管理 |
| 中间件 | cors, helmet, morgan | 跨域、安全、日志中间件 |
| 环境管理 | dotenv | 环境变量管理 |

## **2. 架构设计**

### **2.1 分层架构**

```
┌─────────────────────────────┐
│        API Layer            │
│  Controllers & Routes       │
└─────────────┬───────────────┘
              │
┌─────────────┴───────────────┐
│       Service Layer         │
│   Business Logic & Use Cases│
└─────────────┬───────────────┘
              │
┌─────────────┴───────────────┐
│     Repository Layer        │
│    Data Access & Firestore  │
└─────────────┬───────────────┘
              │
┌─────────────┴───────────────┐
│       Domain Layer          │
│    Entities & Business Rules│
└─────────────────────────────┘
```

### **2.2 目录结构**

```
/backend
  /src
    /controllers
      userController.ts
      meetingController.ts
      preMeetingController.ts
      inMeetingController.ts
      postMeetingController.ts
    /services
      userService.ts
      meetingService.ts
      preMeetingService.ts
      inMeetingService.ts
      postMeetingService.ts
    /repositories
      userRepository.ts
      meetingRepository.ts
      preMeetingRepository.ts
      inMeetingRepository.ts
      postMeetingRepository.ts
    /domain
      entities/
        User.ts
        Meeting.ts
        PreMeeting.ts
        InMeeting.ts
        PostMeeting.ts
      types/
        api.ts
    /middleware
      auth.ts
      errorHandler.ts
      validation.ts
    /config
      firebase.ts
      database.ts
    /utils
      constants.ts
      helpers.ts
    app.ts
    server.ts
```

## **3. 数据模型设计**

### **3.1 Firestore 集合结构**

```typescript
// 用户集合
users: {
  [userId]: {
    id: string;
    name: string;
    avatar?: string;
    createdAt: Timestamp;
    updatedAt: Timestamp;
  }
}

// 会议集合
meetings: {
  [meetingId]: {
    meetingid: string;
    title: string;
    status: 'scheduled' | 'in-progress' | 'completed';
    time: string;
    participants: User[];
    votelink: string;
    createdBy: string;
    createdAt: Timestamp;
    updatedAt: Timestamp;
  }
}

// 会前准备子集合
meetings/{meetingId}/preMeeting: {
  meetingid: string;
  objective: string;
  questions: Question[];
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

// 会中笔记子集合
meetings/{meetingId}/inMeeting: {
  meetingid: string;
  notes: Note[];
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

// 会后总结子集合
meetings/{meetingId}/postMeeting: {
  meetingid: string;
  summary: string;
  feedbacks: Feedback[];
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### **3.2 实体定义**

```typescript
// User Entity
interface User {
  id: string;
  name: string;
  avatar?: string;
  createdAt: Date;
  updatedAt: Date;
}

// Meeting Entity
interface Meeting {
  meetingid: string;
  title: string;
  status: MeetingStatus;
  time: string;
  participants: User[];
  votelink: string;
  createdBy: string;
  createdAt: Date;
  updatedAt: Date;
}

// Question Entity
interface Question {
  id: string;
  meetingid: string;
  author: string;
  authorInitial: string;
  content: string;
  timestamp: string;
}

// Note Entity
interface Note {
  id: string;
  meetingid: string;
  author: string;
  authorInitial: string;
  content: string;
  timestamp: string;
}

// Feedback Entity
interface Feedback {
  id: string;
  meetingid: string;
  author: string;
  authorInitial: string;
  content: string;
  timestamp: string;
}
```

## **4. API 接口设计**

### **4.1 用户管理 API**

| **方法** | **端点** | **描述** | **认证** |
| --- | --- | --- | --- |
| GET | `/api/users` | 获取用户列表 | 必需 |
| POST | `/api/users` | 创建用户 | 必需 |
| GET | `/api/users/:userId` | 获取用户详情 | 必需 |
| PATCH | `/api/users/:userId` | 更新用户信息 | 必需 |
| DELETE | `/api/users/:userId` | 删除用户 | 必需 |

### **4.2 会议管理 API**

| **方法** | **端点** | **描述** | **认证** |
| --- | --- | --- | --- |
| GET | `/api/meetings` | 获取会议列表 | 必需 |
| POST | `/api/meetings` | 创建会议 | 必需 |
| GET | `/api/meetings/:meetingId` | 获取会议详情 | 必需 |
| PATCH | `/api/meetings/:meetingId` | 更新会议信息 | 必需 |
| DELETE | `/api/meetings/:meetingId` | 删除会议 | 必需 |

### **4.3 会前准备 API**

| **方法** | **端点** | **描述** | **认证** |
| --- | --- | --- | --- |
| GET | `/api/meetings/:meetingId/preMeeting` | 获取会前准备 | 必需 |
| POST | `/api/meetings/:meetingId/preMeeting` | 创建会前准备 | 必需 |
| PATCH | `/api/meetings/:meetingId/preMeeting/objective` | 更新目标 | 必需 |
| POST | `/api/meetings/:meetingId/preMeeting/questions` | 添加问题 | 必需 |

### **4.4 会中笔记 API**

| **方法** | **端点** | **描述** | **认证** |
| --- | --- | --- | --- |
| GET | `/api/meetings/:meetingId/inMeeting` | 获取会中笔记 | 必需 |
| POST | `/api/meetings/:meetingId/inMeeting` | 创建会中笔记 | 必需 |
| POST | `/api/meetings/:meetingId/inMeeting/notes` | 添加笔记 | 必需 |

### **4.5 会后总结 API**

| **方法** | **端点** | **描述** | **认证** |
| --- | --- | --- | --- |
| GET | `/api/meetings/:meetingId/postMeeting` | 获取会后总结 | 必需 |
| POST | `/api/meetings/:meetingId/postMeeting` | 创建会后总结 | 必需 |
| PATCH | `/api/meetings/:meetingId/postMeeting/summary` | 更新总结 | 必需 |
| POST | `/api/meetings/:meetingId/postMeeting/feedbacks` | 添加反馈 | 必需 |

## **5. 核心实现**

### **5.1 认证中间件**

```typescript
// middleware/auth.ts
import { Request, Response, NextFunction } from 'express';
import { auth } from '../config/firebase';

export const authenticateToken = async (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  try {
    const token = req.headers.authorization?.split(' ')[1];
    if (!token) {
      return res.status(401).json({ error: '未提供认证令牌' });
    }

    const decodedToken = await auth.verifyIdToken(token);
    req.user = { uid: decodedToken.uid };
    next();
  } catch (error) {
    res.status(401).json({ error: '无效的认证令牌' });
  }
};
```

### **5.2 用户控制器示例**

```typescript
// controllers/userController.ts
import { Request, Response } from 'express';
import { UserService } from '../services/userService';

export class UserController {
  constructor(private userService: UserService) {}

  async getUsers(req: Request, res: Response) {
    try {
      const users = await this.userService.getAllUsers();
      res.json(users);
    } catch (error) {
      res.status(500).json({ error: '获取用户列表失败' });
    }
  }

  async createUser(req: Request, res: Response) {
    try {
      const userData = req.body;
      const user = await this.userService.createUser(userData);
      res.status(201).json(user);
    } catch (error) {
      res.status(400).json({ error: '创建用户失败' });
    }
  }
}
```

### **5.3 用户服务示例**

```typescript
// services/userService.ts
import { UserRepository } from '../repositories/userRepository';
import { User } from '../domain/entities/User';

export class UserService {
  constructor(private userRepository: UserRepository) {}

  async getAllUsers(): Promise<User[]> {
    return await this.userRepository.findAll();
  }

  async createUser(userData: Partial<User>): Promise<User> {
    const user = new User(userData);
    return await this.userRepository.create(user);
  }

  async getUserById(id: string): Promise<User | null> {
    return await this.userRepository.findById(id);
  }
}
```

### **5.4 用户仓储示例**

```typescript
// repositories/userRepository.ts
import { db } from '../config/firebase';
import { User } from '../domain/entities/User';

export class UserRepository {
  private collection = db.collection('users');

  async findAll(): Promise<User[]> {
    const snapshot = await this.collection.get();
    return snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    } as User));
  }

  async create(user: User): Promise<User> {
    const docRef = await this.collection.add({
      ...user,
      createdAt: new Date(),
      updatedAt: new Date()
    });
    return { ...user, id: docRef.id };
  }

  async findById(id: string): Promise<User | null> {
    const doc = await this.collection.doc(id).get();
    if (!doc.exists) return null;
    return { id: doc.id, ...doc.data() } as User;
  }
}
```

## **6. 错误处理**

### **6.1 统一错误响应格式**

```typescript
interface ErrorResponse {
  success: false;
  error: string;
  code?: string;
}

interface SuccessResponse<T> {
  success: true;
  data: T;
}
```

### **6.2 错误处理中间件**

```typescript
// middleware/errorHandler.ts
export const errorHandler = (
  error: Error,
  req: Request,
  res: Response,
  next: NextFunction
) => {
  console.error('Error:', error);
  
  if (error.name === 'ValidationError') {
    return res.status(400).json({
      success: false,
      error: '请求参数验证失败',
      code: 'VALIDATION_ERROR'
    });
  }

  res.status(500).json({
    success: false,
    error: '服务器内部错误',
    code: 'INTERNAL_ERROR'
  });
};
```

## **7. 环境配置**

### **7.1 环境变量**

```env
# Firebase 配置
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_PRIVATE_KEY=your-private-key
FIREBASE_CLIENT_EMAIL=your-client-email

# 服务器配置
PORT=3000
NODE_ENV=development

# CORS 配置
CORS_ORIGIN=http://localhost:5173
```

### **7.2 Firebase 配置**

```typescript
// config/firebase.ts
import { initializeApp, cert } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

const serviceAccount = {
  projectId: process.env.FIREBASE_PROJECT_ID,
  privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
  clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
};

initializeApp({
  credential: cert(serviceAccount)
});

export const db = getFirestore();
export const auth = getAuth();
```

## **8. 部署说明**

### **8.1 构建命令**

```bash
# 安装依赖
npm install

# 开发模式
npm run dev

# 构建生产版本
npm run build

# 启动生产服务器
npm start
```

### **8.2 部署到 Google Cloud**

```yaml
# app.yaml
runtime: nodejs18
service: default

env_variables:
  FIREBASE_PROJECT_ID: your-project-id
  NODE_ENV: production
```

## **9. 安全考虑**

1. **认证**: 所有 API 端点都需要 Firebase Auth 认证
2. **授权**: 用户只能访问自己创建的会议或参与的会议
3. **输入验证**: 对所有输入数据进行验证和清理
4. **CORS**: 配置适当的跨域策略
5. **速率限制**: 实施 API 调用频率限制
6. **日志记录**: 记录所有 API 调用和错误

## **10. 性能优化**

1. **Firestore 索引**: 为常用查询字段创建复合索引
2. **缓存策略**: 对频繁访问的数据实施缓存
3. **分页**: 对列表接口实施分页
4. **连接池**: 优化数据库连接管理
5. **压缩**: 启用响应压缩
