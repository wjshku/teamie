<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teamie - é¡¹ç›®ç®¡ç†å·¥å…·</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #fff;
            color: #333;
            line-height: 1.5;
        }
        
        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* å·¦ä¾§å¯¼èˆªæ  */
        .sidebar {
            width: 200px;
            border-right: 1px solid #ddd;
            background: #f8f8f8;
            padding: 24px 0;
            display: flex;
            flex-direction: column;
        }
        
        .logo {
            font-weight: 700;
            font-size: 16px;
            padding: 0 20px;
            margin-bottom: 30px;
            letter-spacing: 1px;
        }
        
        .nav-item {
            padding: 12px 20px;
            margin: 0 10px;
            cursor: pointer;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.2s ease;
            color: #555;
        }
        
        .nav-item:hover {
            background: #eee;
            color: #333;
        }
        
        .nav-item.active {
            background: #fff;
            border: 1px solid #333;
            color: #333;
            font-weight: 600;
        }
        
        .project-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid #ddd;
            font-size: 11px;
            color: #999;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            border-bottom: 1px solid #ddd;
            padding: 16px 24px;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 12px;
            color: #999;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        /* Tab æ ·å¼ */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 12px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: none;
            color: #999;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            margin-bottom: -14px;
            font-weight: 500;
        }
        
        .tab-btn:hover {
            color: #333;
        }
        
        .tab-btn.active {
            color: #333;
            border-bottom-color: #333;
        }
        
        /* å±å¹•æ ·å¼ */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }
        
        /* æŒ‰é’® */
        .btn {
            padding: 10px 20px;
            border: 1px solid #333;
            background: #fff;
            color: #333;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-radius: 4px;
            display: inline-block;
        }
        
        .btn:hover {
            background: #f0f0f0;
        }
        
        .btn.primary {
            background: #333;
            color: #fff;
            border-color: #333;
        }
        
        .btn.primary:hover {
            background: #555;
            border-color: #555;
        }
        
        /* å¡ç‰‡ç»„ä»¶ */
        .card {
            border: 1px solid #ddd;
            padding: 16px;
            margin-bottom: 16px;
            background: #fff;
            border-radius: 4px;
        }
        
        .card-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        /* ç½‘æ ¼å¸ƒå±€ */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        
        /* è¡¨æ ¼ */
        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .table thead {
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }
        
        .table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        /* é¡¹ç›®åˆ—è¡¨è¡¨æ ¼åˆ—å®½è®¾ç½® */
        #screen4 .table {
            table-layout: fixed;
        }

        #screen4 .table th:nth-child(1),
        #screen4 .table td:nth-child(1) {
            width: 30%;
        }

        #screen4 .table th:nth-child(2),
        #screen4 .table td:nth-child(2) {
            width: 10%;
        }

        #screen4 .table th:nth-child(3),
        #screen4 .table td:nth-child(3) {
            width: 60%;
        }

        #screen4 .table th:nth-child(4),
        #screen4 .table td:nth-child(4) {
            width: 40px;
        }
        
        .table tbody tr:hover {
            background: #fafafa;
            cursor: pointer;
        }

        /* é¡¹ç›®è¡Œæ ·å¼ */
        .project-row {
            position: relative;
        }

        .project-actions {
            width: 40px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .project-row:hover .project-actions {
            opacity: 1;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 3px;
            transition: all 0.15s ease;
            line-height: 1;
        }

        .delete-btn:hover {
            background: rgba(235, 87, 87, 0.1);
            color: #eb5757;
        }

        /* çŠ¶æ€å•å…ƒæ ¼æ ·å¼ */
        .status-cell {
            cursor: pointer;
            padding: 8px 12px;
            transition: all 0.15s ease;
            border-radius: 4px;
            position: relative;
        }

        .status-cell:hover {
            background: rgba(55, 53, 47, 0.08);
        }

        .status-cell.editing {
            outline: none;
            border: none;
            background: transparent;
            cursor: text;
            padding: 8px 12px;
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            color: inherit;
            box-sizing: border-box;
            min-height: 1.2em;
        }

        .status-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            box-sizing: border-box;
            background: #fff;
        }

        .status-input:focus {
            outline: none;
            border-color: #333;
            box-shadow: 0 0 0 2px rgba(51, 51, 51, 0.1);
        }

        /* ä»»åŠ¡åˆ—è¡¨è¡¨æ ¼æ ·å¼ */
        .task-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 8px;
        }

        .task-table th {
            background: #f8f8f8;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border: 1px solid #ddd;
            border-bottom: 2px solid #bbb;
        }

        .task-table td {
            padding: 10px 12px;
            border: 1px solid #ddd;
            vertical-align: top;
            background: #fff;
        }

        .task-table tr:nth-child(even) td {
            background: #fafafa;
        }

        .task-table tr:hover td {
            background: #f0f0f0;
        }

        .task-table .task-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        }

        .task-table .task-desc {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            font-size: 12px;
            color: #555;
            line-height: 1.5;
            font-weight: 400;
        }

        .task-table .priority-badge {
            display: inline-block;
            padding: 2px 6px;
            background: #333;
            color: #fff;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        /* ç»´åº¦æ§åˆ¶æ ·å¼ */
        .dimension-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            padding: 12px;
            background: #f8f8f8;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .dimension-controls.hidden {
            display: none;
        }

        /* ç»´åº¦åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .dimension-toggle-btn {
            margin-left: auto;
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            transition: all 0.2s;
        }

        .dimension-toggle-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .dimension-toggle {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .dimension-toggle:hover {
            background: #f0f0f0;
        }

        .dimension-toggle.active {
            background: #333;
            color: #fff;
            border-color: #333;
        }

        .dimension-toggle.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Zå­—å‹å¸ƒå±€ - ä¸¤åˆ— */
        .report-flex {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .report-section {
            flex: 0 0 calc(50% - 8px);
            min-width: 300px;
            position: relative;
        }

        /* å½“æœ‰3ä¸ªå…ƒç´ æ—¶ï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä¹Ÿåªå 50%å®½åº¦ */
        .report-section:nth-child(3):last-child,
        .report-section:nth-child(5):last-child,
        .report-section:nth-child(7):last-child {
            flex: 0 0 calc(50% - 8px);
            margin-left: calc(25% + 8px); /* å±…ä¸­æ˜¾ç¤º */
        }

        .report-section.hidden {
            display: none;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        /* åé¦ˆæŒ‰é’®æ ·å¼ - ChatGPT é£æ ¼ */
        .feedback-buttons {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .report-section:hover .feedback-buttons {
            opacity: 1;
        }

        .feedback-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 2px;
            opacity: 0.4;
        }

        .feedback-btn:hover {
            opacity: 0.7;
        }

        .feedback-btn.liked,
        .feedback-btn.disliked {
            opacity: 1;
        }

        .feedback-btn svg {
            width: 18px;
            height: 18px;
        }

        .feedback-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.1);
            color: #6b7280;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 9999;
            animation: slideDown 2s ease-in-out;
            pointer-events: none;
            backdrop-filter: blur(10px);
        }

        @keyframes slideDown {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            10% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            90% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
        }

        /* é€šç”¨ Toast é€šçŸ¥æ ·å¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fafafa;
            color: #333;
            padding: 12px 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: top 0.3s ease;
        }

        .toast.success,
        .toast.error,
        .toast.info,
        .toast.warning {
            /* æ‰€æœ‰ç±»å‹ä½¿ç”¨ç»Ÿä¸€çš„æµ…ç°è‰²æ ·å¼ */
            border-color: #ddd;
            background: #fafafa;
            color: #333;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* è¾¾æˆäº‹é¡¹è¡¨æ ¼åˆ—å®½ */
        #completed-tasks .task-table th:nth-child(1),
        #completed-tasks .task-table td:nth-child(1) {
            width: 30%;
        }
        #completed-tasks .task-table th:nth-child(2),
        #completed-tasks .task-table td:nth-child(2) {
            width: 70%;
        }

        /* æœªè¾¾æˆäº‹é¡¹è¡¨æ ¼åˆ—å®½ */
        #not-completed-tasks .task-table th:nth-child(1),
        #not-completed-tasks .task-table td:nth-child(1) {
            width: 30%;
        }
        #not-completed-tasks .task-table th:nth-child(2),
        #not-completed-tasks .task-table td:nth-child(2) {
            width: 30%;
        }
        #not-completed-tasks .task-table th:nth-child(3),
        #not-completed-tasks .task-table td:nth-child(3) {
            width: 40%;
        }

        /* ä¸‹ä¸€æ­¥è®¡åˆ’è¡¨æ ¼åˆ—å®½ */
        #next-steps-list .task-table th:nth-child(1),
        #next-steps-list .task-table td:nth-child(1) {
            width: 10%;
            text-align: center;
        }
        #next-steps-list .task-table th:nth-child(2),
        #next-steps-list .task-table td:nth-child(2) {
            width: 30%;
        }
        #next-steps-list .task-table th:nth-child(3),
        #next-steps-list .task-table td:nth-child(3) {
            width: 60%;
        }

        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            border-radius: 4px;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .upload-area:hover {
            border-color: #333;
            background: #f5f5f5;
        }
        
        .upload-area p {
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .upload-area small {
            font-size: 11px;
            color: #999;
        }
        
        /* æ•°æ®é¡¹ */
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        
        .data-item:last-child {
            border-bottom: none;
        }
        
        .data-label {
            color: #999;
        }
        
        .data-value {
            font-weight: 500;
            color: #333;
        }
        
        /* çŠ¶æ€æŒ‡ç¤º */
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status.completed {
            background: #f0f0f0;
            color: #666;
        }
        
        .status.processing {
            background: #fffbf0;
            color: #d97706;
        }
        
        /* æ–‡æœ¬ */
        .text-muted {
            color: #999;
            font-size: 11px;
        }
        
        .text-highlight {
            font-weight: 600;
            color: #333;
        }
        
        /* å‘¨æœŸå¯¼èˆª */
        .week-nav {
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: center;
            margin-bottom: 24px;
            font-size: 13px;
        }

        .week-nav a {
            color: #666;
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
            transition: color 0.2s;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .week-nav a:hover {
            color: #333;
            background: #f0f0f0;
        }

        .week-current {
            font-weight: 600;
            min-width: 60px;
            text-align: center;
            color: #333;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top-color: #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* ç¼–è¾‘æ¨¡å¼æ ·å¼ - å‚è€ƒ Notion */
        .edit-mode {
            background: #fafafa;
        }

        .editable-row {
            position: relative;
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 3px;
            transition: background-color 0.15s ease;
        }

        .editable-row:hover {
            background: rgba(55, 53, 47, 0.08);
        }

        .editable-row.selected {
            background: rgba(55, 53, 47, 0.12);
            box-shadow: 0 0 0 1px rgba(55, 53, 47, 0.2);
        }

        .editable-text {
            cursor: text;
            outline: none;
            border: none;
            background: transparent;
            padding: 0;
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            color: inherit;
            min-height: 20px;
            width: 100%;
        }

        .editable-text:focus {
            outline: none;
        }

        .editable-text:empty::before {
            content: attr(data-placeholder);
            color: rgba(55, 53, 47, 0.4);
            font-style: normal;
        }

        .row-actions {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .edit-mode .editable-row:hover .row-actions,
        .edit-mode .editable-row.selected .row-actions {
            display: flex;
            opacity: 1;
        }

        .row-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            color: rgba(55, 53, 47, 0.6);
        }

        .row-action-btn:hover {
            background: rgba(55, 53, 47, 0.1);
            color: rgba(55, 53, 47, 0.8);
        }

        .row-action-btn.delete:hover {
            background: rgba(235, 87, 87, 0.1);
            color: rgb(235, 87, 87);
        }

        .add-row-btn {
            width: 100%;
            padding: 8px;
            margin: 4px 0;
            border: 1px dashed rgba(55, 53, 47, 0.2);
            background: transparent;
            border-radius: 3px;
            cursor: pointer;
            color: rgba(55, 53, 47, 0.6);
            transition: all 0.15s ease;
            font-size: 12px;
            display: none;
        }

        .edit-mode .add-row-btn {
            display: block;
        }

        .add-row-btn:hover {
            border-color: rgba(55, 53, 47, 0.3);
            background: rgba(55, 53, 47, 0.05);
            color: rgba(55, 53, 47, 0.8);
        }

        /* ç©ºçŠ¶æ€æ ·å¼ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            margin-bottom: 12px;
            color: #666;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        /* æ–‡ä»¶å¤¹ç»“æ„æ ·å¼ */
        .folder-structure {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 8px;
            background: #fafafa;
        }

        .folder-structure .folder-item {
            padding: 4px 8px;
            margin: 2px 0;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
            font-size: 13px;
            user-select: none;
        }

        .folder-structure .folder-item:hover {
            background: rgba(0, 122, 204, 0.1);
        }

        .folder-structure .folder-item.folder {
            font-weight: 600;
            color: #555;
        }

        .folder-structure .folder-item.file {
            padding-left: 24px;
            color: #777;
        }

        .folder-structure .folder-item.file.html {
            color: #007acc;
            font-weight: 500;
        }

        .folder-structure .folder-item.file.html:hover {
            background: rgba(0, 122, 204, 0.15);
        }

        .folder-structure .folder-toggle {
            display: inline-block;
            width: 12px;
            margin-right: 4px;
            transition: transform 0.2s;
            font-size: 10px;
            vertical-align: middle;
        }

        .folder-structure .folder-toggle.collapsed:before {
            content: "â–¶";
            transform: rotate(90deg);
        }

        .folder-structure .folder-toggle.expanded:before {
            content: "â–¶";
            transform: rotate(180deg);
        }

        .folder-structure .folder-children {
            margin-left: 16px;
        }

        /* Dialog æ ·å¼ */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .dialog {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 800px;
            max-height: 80vh;
            width: 90%;
            overflow: hidden;
            animation: dialogSlideIn 0.2s ease-out;
        }

        @keyframes dialogSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .dialog-header {
            padding: 16px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }

        .dialog-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .dialog-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .dialog-close:hover {
            background: #eee;
            color: #666;
        }

        .dialog-content {
            padding: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }

        .dialog-content pre {
            background: #f8f8f8;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .dialog-content input,
        .dialog-content textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            box-sizing: border-box;
            margin-bottom: 12px;
            margin-left: 0;
            margin-right: 0;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .dialog-content input:focus,
        .dialog-content textarea:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }

        .dialog-add-document .dialog-form-content input,
        .dialog-add-document .dialog-form-content textarea {
            margin-left: 0;
            margin-right: 0;
        }

        .dialog-content textarea {
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        .dialog-content label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .dialog-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        /* æ·»åŠ æ–‡æ¡£å¯¹è¯æ¡†çš„ç‰¹æ®Šæ ·å¼ */
        .dialog-add-document {
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        .dialog-add-document .dialog-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            padding: 20px;
            padding-right: 28px; /* ä¸ºæ»šåŠ¨æ¡ç•™å‡ºç©ºé—´ */
        }

        .dialog-add-document .dialog-form {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .dialog-add-document .dialog-form-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            padding-left: 2px; /* ä¸ºè¾“å…¥æ¡†èšç„¦æ—¶çš„è¾¹æ¡†ç•™å‡ºç©ºé—´ */
            margin-left: 0;
        }

        .dialog-add-document .dialog-actions {
            flex-shrink: 0;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .dialog-add-document textarea {
            flex: 1;
            min-height: 200px;
            max-height: 400px;
        }

        /* ä¾§è¾¹æ æ–‡ä»¶å¤¹ç»“æ„æ ·å¼ */
        .sidebar-folder-structure {
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }

        .sidebar-folder-structure .folder-item {
            padding: 3px 6px;
            margin: 1px 0;
            cursor: pointer;
            border-radius: 2px;
            transition: background-color 0.2s;
            font-size: 10px;
        }

        .sidebar-folder-structure .folder-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-folder-structure .folder-item.folder {
            font-weight: 600;
            color: #ccc;
        }

        .sidebar-folder-structure .folder-item.file {
            padding-left: 16px;
            color: #999;
        }

        .sidebar-folder-structure .folder-item.file.html {
            color: #007acc;
        }

        .sidebar-folder-structure .folder-item.file.html:hover {
            background: rgba(0, 122, 204, 0.1);
        }

        .sidebar-folder-structure .folder-toggle {
            display: inline-block;
            width: 8px;
            margin-right: 2px;
            transition: transform 0.2s;
            font-size: 8px;
        }

        .sidebar-folder-structure .folder-children {
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§å¯¼èˆª -->
        <div class="sidebar">
            <div class="logo">Teamie</div>
            <div class="nav-item" onclick="switchNav('import')">å¯¼å…¥é¡¹ç›®</div>
            <div class="nav-item active" onclick="switchNav('dashboard')">æŸ¥çœ‹é¡¹ç›®è¿›å±•</div>
            <div class="project-info" id="projectInfo" style="display: none;">
                <span id="currentProject">æœªé€‰æ‹©é¡¹ç›®</span><br/>
                <span id="currentPeriod">2025-11-03 è‡³ 2025-11-09</span>
                <!-- æ–‡ä»¶å¤¹ç»“æ„æ˜¾ç¤º -->
                <div id="sidebarFolderStructure" class="sidebar-folder-structure" style="margin-top: 12px;">
                    <!-- æ–‡ä»¶å¤¹ç»“æ„å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main">
            <div class="header">
                <h2 id="screenTitle">é¡¹ç›®è¿›å±•ä¸€è§ˆ</h2>
                <div class="header-right">
                    <span id="headerInfo"></span>
                </div>
            </div>
            
            <div class="content">
                <!-- å±å¹• 1: å¯¼å…¥é¡µé¢ -->
                <div id="screen1" class="screen" style="display: none;">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="switchScreen(1)">å¯¼å…¥é¡¹ç›®</button>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">é€‰æ‹© Notion HTML æ–‡ä»¶å¤¹</div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px;">
                        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                            <p>ğŸ“ æ‹–æ‹½æ–‡ä»¶å¤¹æˆ–ç‚¹å‡»é€‰æ‹©</p>
                                <small>é€‰æ‹©åŒ…å«æ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼ˆæ”¯æŒ html/txt/md æ ¼å¼ï¼Œæ”¯æŒå­é¡µé¢ï¼‰</small>
                                <input type="file" id="fileInput" style="display: none;" webkitdirectory multiple accept=".html,.htm,.txt,.md">
                            </div>
                            <div class="upload-area" onclick="showAddDocumentDialog()" style="cursor: pointer;">
                                <p>ğŸ“ æ‰‹åŠ¨æ·»åŠ æ–‡æ¡£</p>
                                <small>ç‚¹å‡»æ·»åŠ æ–‡æ¡£ï¼Œæ”¯æŒå¤åˆ¶ç²˜è´´å†…å®¹</small>
                            </div>
                        </div>
                    </div>
                    
                        <div class="grid-2">
                            <div>
                                <label for="projectName" style="display: block; font-size: 12px; font-weight: 600; color: #333; margin-bottom: 8px;">é¡¹ç›®åç§°</label>
                                <input type="text" id="projectName" placeholder="è¾“å…¥é¡¹ç›®åç§°" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                            </div>
                            <div>
                                <label for="weekStartDate" style="display: block; font-size: 12px; font-weight: 600; color: #333; margin-bottom: 8px;">æœ¬å‘¨å¼€å§‹æ—¥æœŸï¼ˆå‘¨ä¸€ï¼‰</label>
                                <input type="date" id="weekStartDate" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">æ–‡ä»¶å¤¹çŠ¶æ€</div>
                        <div class="data-item">
                            <span class="data-label">å½“å‰æ–‡ä»¶å¤¹</span>
                            <span class="data-value" id="fileName">æœªé€‰æ‹©</span>
                        </div>
                        <!-- æ–‡ä»¶å¤¹ç»“æ„é¢„è§ˆ -->
                        <div id="folderStructureCard" style="display: none; margin-top: 16px;">
                            <div id="folderStructure" class="folder-structure">
                                <!-- æ–‡ä»¶å¤¹ç»“æ„å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="btn primary" onclick="handleUpload()">ä¸Šä¼ å¹¶åˆ†æ</button>
                        <button class="btn" onclick="cancelImport()">å–æ¶ˆ</button>
                    </div>
                </div>
                
                <!-- å±å¹• 2: åˆ†æè¿›è¡Œä¸­ -->
                <div id="screen2" class="screen" style="display: none;">
                    <div style="text-align: center; padding: 60px 20px;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <h3 style="margin-bottom: 10px;">å¤„ç†ä¸­...</h3>
                        <p class="text-muted">æ­£åœ¨è§£ææ‚¨çš„ Notion æ–‡ä»¶å¤¹</p>
                        
                        <div class="card" style="margin-top: 30px; text-align: left;">
                            <div class="data-item">
                                <span class="data-label">ç¬¦åˆè¦æ±‚çš„æ–‡ä»¶æ•°é‡</span>
                                <span class="data-value" id="processedPages">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Tokenæ•°é‡</span>
                                <span class="data-value" id="usedTokens">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">é¢„è®¡å¤„ç†æ—¶é—´</span>
                                <span class="data-value" id="estimatedTime">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">å¤„ç†è¿›åº¦</span>
                                <span class="data-value" id="processingStatus">åˆå§‹åŒ–ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å±å¹• 3: è¿›å±•æ±‡æŠ¥ -->
                <div id="screen3" class="screen" style="display: none;">
                    <div class="week-nav">
                        <a onclick="changeWeek(-1)">â† ä¸Šä¸€å‘¨</a>
                        <span class="week-current">ç¬¬ 1 å‘¨</span>
                        <a onclick="changeWeek(1)">ä¸‹ä¸€å‘¨ â†’</a>
                        <button class="btn primary" onclick="showImportScreen()">å¯¼å…¥æ–°è¿›å±•</button>
                        <button class="btn" onclick="toggleEditMode()" id="editBtn">ç¼–è¾‘å†…å®¹</button>
                        <button class="btn" onclick="saveAllEdits()" id="saveBtn" style="display: none;">ä¿å­˜ä¿®æ”¹</button>
                        <button class="dimension-toggle-btn" onclick="toggleDimensionControls()">è‡ªå®šä¹‰è§†å›¾</button>
                    </div>

                    <!-- ç»´åº¦æ§åˆ¶ -->
                    <div class="dimension-controls hidden">
                        <button class="dimension-toggle active" data-section="motivation" onclick="toggleDimension(this)">åŠ¨æœºä¸æ–¹å‘</button>
                        <button class="dimension-toggle active" data-section="completed" onclick="toggleDimension(this)">è¾¾æˆäº‹é¡¹</button>
                        <button class="dimension-toggle active" data-section="incomplete" onclick="toggleDimension(this)">æœªè¾¾æˆäº‹é¡¹</button>
                        <button class="dimension-toggle" data-section="internal" onclick="toggleDimension(this)">å†…éƒ¨åæ€</button>
                        <button class="dimension-toggle" data-section="external" onclick="toggleDimension(this)">å¤–éƒ¨åé¦ˆ</button>
                        <button class="dimension-toggle active" data-section="next-steps" onclick="toggleDimension(this)">ä¸‹ä¸€æ­¥è®¡åˆ’</button>
                    </div>

                    <!-- Zå­—å‹å¸ƒå±€ï¼šåŠ¨æœºä¸æ–¹å‘ â†’ å®Œæˆäº‹é¡¹ â†’ æœªå®Œæˆäº‹é¡¹ â†’ å†…éƒ¨åé¦ˆ â†’ å¤–éƒ¨åé¦ˆ â†’ ä¸‹ä¸€æ­¥è®¡åˆ’ -->
                    <div class="report-flex">
                        <!-- ç¬¬ä¸€è¡Œï¼šåŠ¨æœºä¸æ–¹å‘ -->
                        <div class="report-section" data-section="motivation">
                            <div class="section-title">åŠ¨æœºä¸æ–¹å‘</div>
                            <div id="reasons-list"></div>
                            <div id="feedback-motivation" class="feedback-buttons"></div>
                        </div>

                        <!-- ç¬¬äºŒè¡Œï¼šè¾¾æˆäº‹é¡¹ -->
                        <div class="report-section" data-section="completed">
                            <div class="section-title">è¾¾æˆäº‹é¡¹</div>
                            <div id="completed-tasks"></div>
                            <div class="text-muted" id="completed-count" style="padding-top: 8px;"></div>
                            <div id="feedback-completed" class="feedback-buttons"></div>
                        </div>

                        <!-- ç¬¬ä¸‰è¡Œï¼šæœªè¾¾æˆäº‹é¡¹ -->
                        <div class="report-section" data-section="incomplete">
                            <div class="section-title">æœªè¾¾æˆäº‹é¡¹</div>
                            <div id="not-completed-tasks"></div>
                            <div class="text-muted" id="not-completed-count" style="padding-top: 8px;"></div>
                            <div id="feedback-incomplete" class="feedback-buttons"></div>
                        </div>

                        <!-- ç¬¬å››è¡Œï¼šå†…éƒ¨åæ€ -->
                        <div class="report-section hidden" data-section="internal">
                            <div class="section-title">å†…éƒ¨åæ€</div>
                            <div id="why-not-list"></div>
                            <div id="feedback-internal" class="feedback-buttons"></div>
                        </div>

                        <!-- ç¬¬äº”è¡Œï¼šå¤–éƒ¨åé¦ˆ -->
                        <div class="report-section hidden" data-section="external">
                            <div class="section-title">å¤–éƒ¨åé¦ˆ</div>
                            <div id="achievements-list"></div>
                            <div id="feedback-external" class="feedback-buttons"></div>
                        </div>

                        <!-- ç¬¬å…­è¡Œï¼šä¸‹ä¸€æ­¥è®¡åˆ’ -->
                        <div class="report-section" data-section="next-steps">
                            <div class="section-title">ä¸‹ä¸€æ­¥è®¡åˆ’</div>
                            <div id="next-steps-list"></div>
                            <div id="feedback-next-steps" class="feedback-buttons"></div>
                        </div>
                    </div>
                </div>
                
                <!-- å±å¹• 4: é¡¹ç›®åˆ—è¡¨ -->
                <div id="screen4" class="screen active" style="display: block;">
                    <div style="margin-bottom: 16px;">
                        <div id="project-stats" style="font-size: 12px; color: #666;"></div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>é¡¹ç›®åç§°</th>
                                <th>å½“å‰å‘¨æœŸ</th>
                                <th>çŠ¶æ€ä¸è¯„ä»·</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="project-list">
                            <!-- é¡¹ç›®æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // APIé…ç½®
        const API_BASE_URL = '/api';

        // å…¨å±€çŠ¶æ€
        let currentProject = null;
        let currentWeek = 1;
        // æ‰‹åŠ¨æ·»åŠ çš„æ–‡æ¡£åˆ—è¡¨
        let manualDocuments = [];
        let isEditMode = false;
        let projects = []; // é¡¹ç›®åˆ—è¡¨

        // APIè°ƒç”¨å‡½æ•°
        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            try {
                const response = await fetch(url, { ...defaultOptions, ...options });
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status} ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }

        // åŠ è½½é¡¹ç›®åˆ—è¡¨
        async function loadProjects() {
            try {
                projects = await apiCall('/projects');
                renderProjectList();
                updateProjectStats();
                return projects;
            } catch (error) {
                console.error('Failed to load projects:', error);
                projects = [];
                renderProjectList();
                updateProjectStats();
                return [];
            }
        }

        // åŠ è½½é¡¹ç›®å‘¨æŠ¥
        async function loadWeekReport(projectId, week) {
            try {
                const report = await apiCall(`/projects/${projectId}/week/${week}`);
                return report;
            } catch (error) {
                console.log(`Week ${week} data not available for project ${projectId}:`, error.message);
                return null;
            }
        }

        // è·å–é¡¹ç›®ä¿¡æ¯
        async function getProjectInfo(projectId) {
            try {
                const projectInfo = await apiCall(`/projects/${projectId}`);
                return projectInfo;
            } catch (error) {
                console.error('Failed to get project info:', error);
                return null;
            }
        }

        // ä¸Šä¼ æ–‡ä»¶ï¼ˆæ”¯æŒå¤šæ–‡ä»¶ï¼‰
        async function uploadFiles(files, projectName, weekStartDate) {
            const formData = new FormData();

            // æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ° FormData
            if (files && files.length > 0) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log(`å¤„ç†æ–‡ä»¶ ${i + 1}:`, {
                    name: file.name,
                    webkitRelativePath: file.webkitRelativePath,
                    type: file.type,
                    size: file.size
                });

                    // åªæ·»åŠ æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼ˆhtml/txt/mdï¼‰
                    const supportedExtensions = ['.html', '.htm', '.txt', '.md'];
                    const fileName = file.name.toLowerCase();
                    const lastDot = fileName.lastIndexOf('.');
                    const fileExt = lastDot > 0 ? '.' + fileName.substring(lastDot + 1) : '';
                    if (supportedExtensions.includes(fileExt)) {
                        console.log(`æ·»åŠ æ–‡ä»¶: ${file.name}`);
                    // ç›´æ¥æ·»åŠ åŸå§‹æ–‡ä»¶ï¼Œåç«¯ä¼šå¤„ç†æ–‡ä»¶åæ¸…ç†
                    formData.append('files', file);
                } else {
                        console.log(`è·³è¿‡ä¸æ”¯æŒçš„æ–‡ä»¶: ${file.name}`);
                    }
                }
            }

            // æ·»åŠ æ‰‹åŠ¨æ·»åŠ çš„æ–‡æ¡£
            if (manualDocuments && manualDocuments.length > 0) {
                console.log(`æ·»åŠ  ${manualDocuments.length} ä¸ªæ‰‹åŠ¨æ–‡æ¡£`);
                manualDocuments.forEach((doc, index) => {
                    // å°†å†…å®¹è½¬æ¢ä¸º File å¯¹è±¡
                    // æ ¹æ®å†…å®¹åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼Œä¼˜å…ˆä½¿ç”¨ .html
                    const blob = new Blob([doc.content], { type: 'text/html' });
                    const fileName = doc.title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_') + '.html';
                    const file = new File([blob], fileName, { type: 'text/html' });
                    formData.append('files', file);
                    console.log(`æ·»åŠ æ‰‹åŠ¨æ–‡æ¡£: ${fileName}`);
                });
            }

            formData.append('project_name', projectName);
            formData.append('week_start_date', weekStartDate);

            try {
                const response = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Upload error:', error);
                throw error;
            }
        }

        // æ›´æ–°å®Œæ•´å‘¨æŠ¥
        async function updateWeekReport(projectId, week, weekData) {
            try {
                const result = await apiCall(`/projects/${projectId}/week/${week}`, {
                    method: 'PUT',
                    body: JSON.stringify(weekData)
                });
                return result;
            } catch (error) {
                console.error('Failed to update week report:', error);
                throw error;
            }
        }

        // åˆ‡æ¢å¯¼èˆª
        function switchNav(type) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');

            const projectInfo = document.getElementById('projectInfo');
            if (type === 'dashboard') {
                projectInfo.style.display = 'block';
                showScreen('screen4');
                document.getElementById('screenTitle').textContent = 'é¡¹ç›®è¿›å±•ä¸€è§ˆ';
            } else {
                projectInfo.style.display = 'none';
                showScreen('screen1');
                document.getElementById('screenTitle').textContent = 'å¯¼å…¥æ–°é¡¹ç›®';
                // é‡ç½®å¯¼å…¥è¡¨å•åˆ°åˆå§‹çŠ¶æ€
                resetImportForm();
            }
        }

        // æ˜¾ç¤ºå¯¼å…¥å±å¹•ï¼ˆå¸¦é‡ç½®ï¼‰
        function showImportScreen() {
            resetImportForm();
            showScreen('screen1');
            document.getElementById('screenTitle').textContent = 'å¯¼å…¥æ–°è¿›å±•';
            // éšè—é¡¹ç›®ä¿¡æ¯
            const projectInfo = document.getElementById('projectInfo');
            projectInfo.style.display = 'none';
        }

        // æ˜¾ç¤ºå±å¹•
        function showScreen(screenId) {
            console.log('Switching to screen:', screenId);
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.style.display = 'none';
                screen.classList.remove('active');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.style.display = 'block';
                targetScreen.classList.add('active');
                console.log('Screen switched successfully:', screenId);

                // å½“åˆ‡æ¢åˆ°å¯¼å…¥é¡µé¢æ—¶ï¼Œè®¾ç½®é»˜è®¤é¡¹ç›®ä¿¡æ¯
                if (screenId === 'screen1') {
                    setDefaultProjectInfo();
                }

                // å½“åˆ‡æ¢åˆ°é¡¹ç›®åˆ—è¡¨æ—¶ï¼Œéšè—é¡¹ç›®ä¿¡æ¯åŒºåŸŸ
                if (screenId === 'screen4') {
                    const projectInfo = document.getElementById('projectInfo');
                    projectInfo.style.display = 'none';
                }
            } else {
                console.error('Screen not found:', screenId);
            }
        }

        // åˆ‡æ¢å±å¹•ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
        function switchScreen(num) {
            showScreen('screen' + num);
        }

        // æ¸²æŸ“é¡¹ç›®åˆ—è¡¨
        function renderProjectList() {
            const tbody = document.getElementById('project-list');
            if (!tbody) return;

            if (projects.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 60px 20px; color: #999;">
                            <div class="empty-state">
                                <h3>æš‚æ— é¡¹ç›®</h3>
                                <p>è¯·å…ˆä¸Šä¼  Notion HTML æ–‡ä»¶æ¥å¯¼å…¥é¡¹ç›®</p>
                                <button class="btn primary" onclick="showScreen('screen1')">å¯¼å…¥é¡¹ç›®</button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = projects.map(project => `
                <tr class="project-row" onclick="selectProject('${project.id}', '${project.name}')">
                    <td><strong>${project.name}</strong></td>
                    <td>ç¬¬ ${project.current_week} å‘¨</td>
                    <td class="status-cell" data-project="${project.id}" onclick="editStatus(this, event)">${project.status}</td>
                    <td class="project-actions">
                        <button class="delete-btn" onclick="deleteProject('${project.id}', '${project.name}', event)" title="åˆ é™¤é¡¹ç›®">Ã—</button>
                    </td>
                </tr>
            `).join('');
        }

        // æ›´æ–°é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯
        function updateProjectStats() {
            const statsElement = document.getElementById('project-stats');
            if (projects.length > 0) {
                statsElement.textContent = `å…± ${projects.length} ä¸ªé¡¹ç›®`;
            } else {
                statsElement.textContent = '';
            }
        }

        // é€‰æ‹©é¡¹ç›®
        async function selectProject(projectId, projectName) {
            console.log('Selecting project:', projectId, projectName);

            // æ‰¾åˆ°é¡¹ç›®ï¼ˆé€šè¿‡IDåŒ¹é…ï¼‰
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                    showToast('é¡¹ç›®ä¸å­˜åœ¨', 'error');
                return;
            }

            currentProject = projectId;  // ä½¿ç”¨é¡¹ç›®IDè€Œä¸æ˜¯åç§°
            currentWeek = project.current_week || 1;

            document.getElementById('currentProject').textContent = projectName;
            document.getElementById('screenTitle').textContent = 'è¿›å±•æ±‡æŠ¥ - ' + projectName;

            try {
                const reportData = await loadWeekReport(projectId, currentWeek);
                if (reportData) {
                    // è®¾ç½®å‘¨æ•°å’Œå·¦ä¸‹è§’çš„æ—¥æœŸæ˜¾ç¤º
                    document.querySelector('.week-current').textContent = 'ç¬¬ ' + currentWeek + ' å‘¨';
                    const currentPeriodElement = document.getElementById('currentPeriod');
                    if (currentPeriodElement) {
                        currentPeriodElement.textContent = reportData.week_period || '2025-11-03 è‡³ 2025-11-09';
                    }

                    renderReport(reportData);

                    // æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯åŒºåŸŸ
                    const projectInfo = document.getElementById('projectInfo');
                    projectInfo.style.display = 'block';

                    // æ›´æ–°ä¾§è¾¹æ æ–‡ä»¶å¤¹ç»“æ„
                    updateSidebarFolderStructure(projectId, currentWeek);

                    showScreen('screen3');
                } else {
                    showToast('æœªæ‰¾åˆ°æŠ¥å‘Šæ•°æ®', 'warning');
                }
            } catch (error) {
                showToast('åŠ è½½æŠ¥å‘Šå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“æŠ¥å‘Š
        function renderReport(data) {
            // æ¸²æŸ“"åšäº†ä»€ä¹ˆ" (è¾¾æˆäº‹é¡¹)
            const completedTasksContainer = document.getElementById('completed-tasks');
            const completedCountContainer = document.getElementById('completed-count');

            if (completedTasksContainer && data.completed_tasks) {
                if (data.completed_tasks.length > 0) {
                    completedTasksContainer.innerHTML = `
                        <table class="task-table">
                            <thead>
                                <tr>
                                    <th>ä»»åŠ¡åç§°</th>
                                    <th>å®Œæˆæƒ…å†µ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.completed_tasks.map((task, index) => `
                                    <tr class="editable-row" data-path="completed_tasks" data-index="${index}">
                                        <td>
                                            <div class="task-name editable-text" data-path="completed_tasks" data-index="${index}" data-field="task" data-placeholder="ä»»åŠ¡åç§°">${task.task}</div>
                                        </td>
                                        <td>
                                            <div class="task-desc editable-text" data-path="completed_tasks" data-index="${index}" data-field="description" data-placeholder="ä»»åŠ¡æè¿°">${task.description}</div>
                                        </td>
                                        <td class="row-actions">
                                            <button class="row-action-btn delete" title="åˆ é™¤">Ã—</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <button class="add-row-btn" data-path="completed_tasks">+ æ·»åŠ å®Œæˆä»»åŠ¡</button>
                    `;
                } else {
                    completedTasksContainer.innerHTML = '<p class="text-muted">æš‚æ— è¾¾æˆäº‹é¡¹</p>';
                }
            }

            if (completedCountContainer && data.completed_tasks) {
                completedCountContainer.textContent = `å…± ${data.completed_tasks.length} ä¸ªä»»åŠ¡å®Œæˆ`;
            }

            // æ¸²æŸ“"ä¸ºä»€ä¹ˆè¿™æ ·åš" (åŠ¨æœºä¸æ–¹å‘)
            const reasonsContainer = document.getElementById('reasons-list');
            if (reasonsContainer && data.motivation_direction) {
                if (data.motivation_direction.length > 0) {
                    reasonsContainer.innerHTML = `
                        ${data.motivation_direction.map((item, index) => `
                            <div class="data-item editable-row" data-path="motivation_direction" data-index="${index}">
                                <span class="editable-text" data-path="motivation_direction" data-index="${index}" data-field="item" data-placeholder="è¾“å…¥åŠ¨æœºæ–¹å‘">${item}</span>
                                <div class="row-actions">
                                    <button class="row-action-btn delete" title="åˆ é™¤">Ã—</button>
                                </div>
                            </div>
                        `).join('')}
                        <button class="add-row-btn" data-path="motivation_direction">+ æ·»åŠ åŠ¨æœºæ–¹å‘</button>
                    `;
                } else {
                    reasonsContainer.innerHTML = '<p class="text-muted">æš‚æ— åŠ¨æœºæ–¹å‘ä¿¡æ¯</p>';
                }
            }

            // æ¸²æŸ“"æ²¡åšä»€ä¹ˆ" (æœªè¾¾æˆäº‹é¡¹)
            const notCompletedTasksContainer = document.getElementById('not-completed-tasks');
            const notCompletedCountContainer = document.getElementById('not-completed-count');

            if (notCompletedTasksContainer && data.incomplete_tasks) {
                if (data.incomplete_tasks.length > 0) {
                    notCompletedTasksContainer.innerHTML = `
                        <table class="task-table">
                            <thead>
                                <tr>
                                    <th>ä»»åŠ¡åç§°</th>
                                    <th>é¢„æœŸç›®æ ‡</th>
                                    <th>æœªå®ŒæˆåŸå› </th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.incomplete_tasks.map((task, index) => `
                                    <tr class="editable-row" data-path="incomplete_tasks" data-index="${index}">
                                        <td>
                                            <div class="task-name editable-text" data-path="incomplete_tasks" data-index="${index}" data-field="task" data-placeholder="ä»»åŠ¡åç§°">${task.task}</div>
                                        </td>
                                        <td>
                                            <div class="task-desc editable-text" data-path="incomplete_tasks" data-index="${index}" data-field="expected" data-placeholder="é¢„æœŸç›®æ ‡">${task.expected}</div>
                                        </td>
                                        <td>
                                            <div class="task-desc editable-text" data-path="incomplete_tasks" data-index="${index}" data-field="reason" data-placeholder="æœªå®ŒæˆåŸå› ">${task.reason}</div>
                                        </td>
                                        <td class="row-actions">
                                            <button class="row-action-btn delete" title="åˆ é™¤">Ã—</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <button class="add-row-btn" data-path="incomplete_tasks">+ æ·»åŠ æœªå®Œæˆä»»åŠ¡</button>
                    `;
                    if (notCompletedCountContainer) {
                        notCompletedCountContainer.textContent = `${data.incomplete_tasks.length} ä¸ªä»»åŠ¡æœªå®Œæˆ`;
                    }
                } else {
                    notCompletedTasksContainer.innerHTML = '<p class="text-muted">æš‚æ— æœªå®Œæˆä»»åŠ¡</p>';
                    if (notCompletedCountContainer) {
                        notCompletedCountContainer.textContent = '';
                    }
                }
            }

            // æ¸²æŸ“"ä¸ºä»€ä¹ˆæ²¡åš" (å†…éƒ¨åæ€)
            const whyNotContainer = document.getElementById('why-not-list');
            if (whyNotContainer && data.internal_reflection) {
                if (data.internal_reflection.length > 0) {
                    whyNotContainer.innerHTML = `
                        ${data.internal_reflection.map((item, index) => `
                            <div class="data-item editable-row" data-path="internal_reflection" data-index="${index}">
                                <span class="editable-text" data-path="internal_reflection" data-index="${index}" data-field="item" data-placeholder="è¾“å…¥å†…éƒ¨åæ€">${item}</span>
                                <div class="row-actions">
                                    <button class="row-action-btn delete" title="åˆ é™¤">Ã—</button>
                                </div>
                            </div>
                        `).join('')}
                        <button class="add-row-btn" data-path="internal_reflection">+ æ·»åŠ å†…éƒ¨åæ€</button>
                    `;
                } else {
                    whyNotContainer.innerHTML = '<p class="text-muted">æš‚æ— å†…éƒ¨åæ€</p>';
                }
            }

            // æ¸²æŸ“"æˆæ•ˆä¸åé¦ˆ" (å¤–éƒ¨åé¦ˆ)
            const achievementsContainer = document.getElementById('achievements-list');
            if (achievementsContainer && data.external_feedback) {
                if (data.external_feedback.length > 0) {
                    achievementsContainer.innerHTML = `
                        ${data.external_feedback.map((feedback, index) => `
                            <div class="data-item editable-row" data-path="external_feedback" data-index="${index}">
                                <div class="task-name editable-text" data-path="external_feedback" data-index="${index}" data-field="source" data-placeholder="åé¦ˆæ¥æº">${feedback.source}</div>
                                <div class="task-desc editable-text" data-path="external_feedback" data-index="${index}" data-field="content" data-placeholder="åé¦ˆå†…å®¹">${feedback.content}</div>
                                <div class="row-actions">
                                    <button class="row-action-btn delete" title="åˆ é™¤">Ã—</button>
                                </div>
                            </div>
                        `).join('')}
                        <button class="add-row-btn" data-path="external_feedback">+ æ·»åŠ å¤–éƒ¨åé¦ˆ</button>
                    `;
                } else {
                    achievementsContainer.innerHTML = '<p class="text-muted">æš‚æ— å¤–éƒ¨åé¦ˆ</p>';
                }
            }

            // æ¸²æŸ“"ä¸‹ä¸€æ­¥è®¡åˆ’"
            const nextStepsContainer = document.getElementById('next-steps-list');
            if (nextStepsContainer && data.next_week_plan) {
                if (data.next_week_plan.length > 0) {
                    nextStepsContainer.innerHTML = `
                        <table class="task-table">
                            <thead>
                                <tr>
                                    <th>ä¼˜å…ˆçº§</th>
                                    <th>ä»»åŠ¡åç§°</th>
                                    <th>ç›®æ ‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.next_week_plan.map((plan, index) => `
                                    <tr class="editable-row" data-path="next_week_plan" data-index="${index}">
                                        <td>
                                            <span class="priority-badge editable-text" data-path="next_week_plan" data-index="${index}" data-field="priority" data-placeholder="P1">${typeof plan.priority === 'string' && plan.priority.startsWith('P') ? plan.priority : 'P' + (plan.priority || 1)}</span>
                                        </td>
                                        <td>
                                            <div class="task-name editable-text" data-path="next_week_plan" data-index="${index}" data-field="task" data-placeholder="ä»»åŠ¡åç§°">${plan.task || ''}</div>
                                        </td>
                                        <td>
                                            <div class="task-desc editable-text" data-path="next_week_plan" data-index="${index}" data-field="goal" data-placeholder="ç›®æ ‡æè¿°">${plan.goal || ''}</div>
                                        </td>
                                        <td class="row-actions">
                                            <button class="row-action-btn delete" title="åˆ é™¤">Ã—</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <button class="add-row-btn" data-path="next_week_plan">+ æ·»åŠ ä¸‹ä¸€æ­¥è®¡åˆ’</button>
                    `;
                } else {
                    nextStepsContainer.innerHTML = '<p class="text-muted">æš‚æ— ä¸‹ä¸€æ­¥è®¡åˆ’</p>';
                }
            }

            // åˆå§‹åŒ–åé¦ˆæŒ‰é’®
            initializeFeedbackButtons();
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleUpload() {
            console.log('handleUpload called');
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            const projectNameInput = document.getElementById('projectName');
            const weekStartDateInput = document.getElementById('weekStartDate');

            // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æˆ–æ‰‹åŠ¨æ·»åŠ çš„æ–‡æ¡£
            const hasFiles = files && files.length > 0;
            const hasManualDocs = manualDocuments && manualDocuments.length > 0;
            
            if (!hasFiles && !hasManualDocs) {
                showToast('è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹æˆ–æ·»åŠ æ–‡æ¡£', 'warning');
                return;
            }

            const projectName = projectNameInput.value.trim();
            if (!projectName) {
                showToast('è¯·è¾“å…¥é¡¹ç›®åç§°', 'warning');
                projectNameInput.focus();
                return;
            }

            const weekStartDate = weekStartDateInput.value;
            if (!weekStartDate) {
                showToast('è¯·é€‰æ‹©æœ¬å‘¨å¼€å§‹æ—¥æœŸ', 'warning');
                weekStartDateInput.focus();
                return;
            }

            // æ˜¾ç¤ºé€‰æ‹©çš„æ–‡ä»¶å¤¹ä¿¡æ¯
            const folderPath = files[0].webkitRelativePath.split('/')[0];
            document.getElementById('fileName').textContent = `æ–‡ä»¶å¤¹: ${folderPath}`;

            try {
                // å…ˆæ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€ï¼ˆä¸è·³è½¬é¡µé¢ï¼‰
                updateProcessingStatus({
                    pages: 0,
                    tokens: 0,
                    estimatedTime: 'è®¡ç®—ä¸­...',
                    status: 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶å¹¶è®¡ç®—...'
                });

                console.log('å¼€å§‹ä¸Šä¼ æ–‡ä»¶...');

                // ç­‰å¾…ä¸Šä¼ å®Œæˆå¹¶æ”¶åˆ°å“åº”
                const result = await uploadFiles(files, projectName, weekStartDate);
                console.log('ä¸Šä¼ ç»“æœ:', result);

                if (result && result.success) {
                    // æ”¶åˆ°å“åº”åï¼Œè·³è½¬åˆ°å¤„ç†ä¸­é¡µé¢
                    showScreen('screen2');

                    // ä½¿ç”¨åç«¯è¿”å›çš„å®é™…æ•°æ®æ›´æ–°çŠ¶æ€
                        updateProcessingStatus({
                        pages: result.file_count || 0,
                        tokens: result.token_count || 0,
                        estimatedTime: formatEstimatedTime(result.estimated_time_seconds || 0),
                        status: 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨åå°åˆ†æ...'
                    });

                    showToast('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼ç³»ç»Ÿæ­£åœ¨åå°å¤„ç†æ‚¨çš„å†…å®¹ã€‚', 'success');

                        // æ‰§è¡Œåç»­æ“ä½œ
                        await resetImportForm();
                    await loadProjects();

                        if (result.project_id) {
                            const newProject = projects.find(p => p.id === result.project_id);
                            if (newProject) {
                                await selectProject(result.project_id, newProject.name);
                            } else {
                    showScreen('screen4');
                    document.getElementById('screenTitle').textContent = 'é¡¹ç›®è¿›å±•ä¸€è§ˆ';
                            }
                } else {
                            showScreen('screen4');
                            document.getElementById('screenTitle').textContent = 'é¡¹ç›®è¿›å±•ä¸€è§ˆ';
                        }
                    } else {
                    // ä¸Šä¼ å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    showScreen('screen2');
                        updateProcessingStatus({
                            pages: 0,
                            tokens: 0,
                        estimatedTime: '0ç§’',
                        status: 'ä¸Šä¼ å¤±è´¥: ' + (result?.message || 'æœªçŸ¥é”™è¯¯')
                    });
                }
            } catch (error) {
                console.error('ä¸Šä¼ è¿‡ç¨‹å‡ºé”™:', error);
                // è·³è½¬åˆ°å¤„ç†ä¸­é¡µé¢æ˜¾ç¤ºé”™è¯¯
                showScreen('screen2');
                updateProcessingStatus({
                    pages: 0,
                    tokens: 0,
                    estimatedTime: '0ç§’',
                    status: 'ä¸Šä¼ å¤±è´¥: ' + error.message
                });
                showToast('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤é¡¹ç›®
        async function deleteProject(projectId, projectName, event) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è¡Œç‚¹å‡»

            if (!confirm(`ç¡®å®šè¦åˆ é™¤é¡¹ç›®"${projectName}"å—ï¼Ÿ\n\nè¿™å°†æ°¸ä¹…åˆ é™¤è¯¥é¡¹ç›®çš„æ‰€æœ‰æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                return;
            }

            try {
                // è°ƒç”¨åˆ é™¤API
                await apiCall(`/projects/${projectId}`, {
                    method: 'DELETE'
                });

                showToast('é¡¹ç›®åˆ é™¤æˆåŠŸ', 'success');
                // é‡æ–°åŠ è½½é¡¹ç›®åˆ—è¡¨
                await loadProjects();
            } catch (error) {
                console.error('åˆ é™¤é¡¹ç›®å¤±è´¥:', error);
                showToast('åˆ é™¤é¡¹ç›®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å–æ¶ˆå¯¼å…¥
        function cancelImport() {
            console.log('cancelImport called');

            // éšè—é¡¹ç›®ä¿¡æ¯åŒºåŸŸ
            const projectInfo = document.getElementById('projectInfo');
            projectInfo.style.display = 'none';

            showScreen('screen4');
            document.getElementById('screenTitle').textContent = 'é¡¹ç›®è¿›å±•ä¸€è§ˆ';
        }

        // è·å–æœ¬å‘¨ä¸€çš„æ—¥æœŸ
        function getThisMonday() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // è°ƒæ•´ä¸ºå‘¨ä¸€
            const monday = new Date(today.setDate(diff));
            return monday.toISOString().split('T')[0]; // è¿”å›YYYY-MM-DDæ ¼å¼
        }

        // è®¾ç½®é»˜è®¤é¡¹ç›®ä¿¡æ¯
        function setDefaultProjectInfo() {
            const weekStartDateInput = document.getElementById('weekStartDate');
            if (weekStartDateInput) {
                weekStartDateInput.value = getThisMonday();
            }

            const projectNameInput = document.getElementById('projectName');
            if (projectNameInput) {
                projectNameInput.value = '';
                projectNameInput.focus();
            }
        }

        // æ”¹å˜å‘¨æ•°
        async function changeWeek(direction) {
            console.log('Changing week, direction:', direction);
            const current = parseInt(document.querySelector('.week-current').textContent.match(/\d+/)[0]);
            const newWeek = current + direction;

            // å…ˆè·å–é¡¹ç›®ä¿¡æ¯æ¥æ£€æŸ¥è¾¹ç•Œ
            const projectInfo = await getProjectInfo(currentProject);
            if (!projectInfo) {
                showToast('æ— æ³•è·å–é¡¹ç›®ä¿¡æ¯', 'error');
                return;
            }

            const maxWeek = projectInfo.total_weeks;

            // æ£€æŸ¥è¾¹ç•Œ
            if (newWeek < 1) {
                showToast('å·²ç»æ˜¯ç¬¬ä¸€å‘¨æ•°æ®', 'info');
                return;
            }

            if (newWeek > maxWeek) {
                showToast('æš‚æ— ä¸‹ä¸€å‘¨æ•°æ®', 'info');
                return;
            }

            try {
                const reportData = await loadWeekReport(currentProject, newWeek);
                if (reportData) {
                    currentWeek = newWeek;
                    document.querySelector('.week-current').textContent = 'ç¬¬ ' + newWeek + ' å‘¨';

                    // æ›´æ–°å·¦ä¸‹è§’çš„æ—¥æœŸæ˜¾ç¤º
                    const currentPeriodElement = document.getElementById('currentPeriod');
                    if (currentPeriodElement) {
                        currentPeriodElement.textContent = reportData.week_period || '2025-11-03 è‡³ 2025-11-09';
                    }

                    // æ›´æ–°å·¦ä¾§è¾¹æ æ–‡ä»¶å¤¹ç»“æ„
                    updateSidebarFolderStructure(currentProject, newWeek);

                    renderReport(reportData);
                    console.log('Week changed to:', newWeek);
                } else {
                    showToast('è¯¥å‘¨æ•°æ®åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                console.log('Unexpected error loading week:', newWeek, 'Error:', error.message);
                showToast('æ•°æ®åŠ è½½å‡ºé”™ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // è¿›å…¥ç¼–è¾‘æ¨¡å¼
        function toggleEditMode() {
            isEditMode = true;
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const container = document.querySelector('.container');

            // éšè—"ç¼–è¾‘å†…å®¹"æŒ‰é’®ï¼Œæ˜¾ç¤º"ä¿å­˜ä¿®æ”¹"æŒ‰é’®
            editBtn.style.display = 'none';
                saveBtn.style.display = 'inline-block';
                container.classList.add('edit-mode');
                enableInlineEditing();
        }

        // é€€å‡ºç¼–è¾‘æ¨¡å¼
        function exitEditMode() {
            isEditMode = false;
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const container = document.querySelector('.container');

            // æ˜¾ç¤º"ç¼–è¾‘å†…å®¹"æŒ‰é’®ï¼Œéšè—"ä¿å­˜ä¿®æ”¹"æŒ‰é’®
            editBtn.style.display = 'inline-block';
                saveBtn.style.display = 'none';
                container.classList.remove('edit-mode');
                disableInlineEditing();
        }

        // ä¿å­˜æ‰€æœ‰ç¼–è¾‘
        async function saveAllEdits() {
            if (!currentProject) {
                showToast('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning');
                return;
            }

            try {
                const weekData = collectCurrentWeekData();
                await updateWeekReport(currentProject, currentWeek, weekData);
                showToast('ä¿å­˜æˆåŠŸï¼', 'success');
                // ä¿å­˜æˆåŠŸåé€€å‡ºç¼–è¾‘æ¨¡å¼
                exitEditMode();
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ”¶é›†å½“å‰é¡µé¢æ•°æ®
        function collectCurrentWeekData() {
            const data = {
                completed_tasks: [],
                incomplete_tasks: [],
                motivation_direction: [],
                internal_reflection: [],
                external_feedback: [],
                next_week_plan: []
            };

            // æ”¶é›†è¾¾æˆäº‹é¡¹
            const completedTaskRows = document.querySelectorAll('#completed-tasks .editable-row');
            completedTaskRows.forEach(row => {
                const task = (row.querySelector('[data-field="task"]')?.textContent || '').trim();
                const description = (row.querySelector('[data-field="description"]')?.textContent || '').trim();
                // åªè¦æœ‰ä»»åŠ¡åç§°å°±ä¿å­˜ï¼ˆdescription å¯ä»¥ä¸ºç©ºï¼‰
                if (task) {
                    data.completed_tasks.push({ 
                        task: task, 
                        description: description || ''  // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²ï¼Œä¸èƒ½æ˜¯ undefined
                    });
                }
            });

            // æ”¶é›†æœªè¾¾æˆäº‹é¡¹
            const incompleteTaskRows = document.querySelectorAll('#not-completed-tasks .editable-row');
            incompleteTaskRows.forEach(row => {
                const task = (row.querySelector('[data-field="task"]')?.textContent || '').trim();
                const expected = (row.querySelector('[data-field="expected"]')?.textContent || '').trim();
                const reason = (row.querySelector('[data-field="reason"]')?.textContent || '').trim();
                // åªè¦æœ‰ä»»åŠ¡åç§°å°±ä¿å­˜
                if (task) {
                    data.incomplete_tasks.push({
                        task: task,
                        expected: expected || '',  // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                        reason: reason || ''      // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                    });
                }
            });

            // æ”¶é›†åŠ¨æœºä¸æ–¹å‘
            const motivationItems = document.querySelectorAll('#reasons-list .editable-row [data-field="item"]');
            motivationItems.forEach(item => {
                const content = item.textContent?.trim();
                if (content) {
                    data.motivation_direction.push(content);
                }
            });

            // æ”¶é›†å†…éƒ¨åæ€
            const reflectionItems = document.querySelectorAll('#why-not-list .editable-row [data-field="item"]');
            reflectionItems.forEach(item => {
                const content = item.textContent?.trim();
                if (content) {
                    data.internal_reflection.push(content);
                }
            });

            // æ”¶é›†å¤–éƒ¨åé¦ˆ
            const feedbackItems = document.querySelectorAll('#achievements-list .editable-row');
            feedbackItems.forEach(item => {
                const source = (item.querySelector('[data-field="source"]')?.textContent || '').trim();
                const content = (item.querySelector('[data-field="content"]')?.textContent || '').trim();
                // åªè¦æœ‰æ¥æºæˆ–å†…å®¹å°±ä¿å­˜
                if (source || content) {
                    data.external_feedback.push({
                        source: source || '',   // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                        content: content || ''  // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                    });
                }
            });

            // æ”¶é›†ä¸‹ä¸€æ­¥è®¡åˆ’
            const planRows = document.querySelectorAll('#next-steps-list .editable-row');
            planRows.forEach(row => {
                const task = (row.querySelector('[data-field="task"]')?.textContent || '').trim();
                const goal = (row.querySelector('[data-field="goal"]')?.textContent || '').trim();
                let priorityText = (row.querySelector('[data-field="priority"]')?.textContent || 'P1').trim();
                
                // ç¡®ä¿ priority æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼ˆP0, P1, P2ï¼‰
                if (!priorityText || !priorityText.startsWith('P')) {
                    // å¦‚æœæ˜¯æ•°å­—æˆ–ç©ºï¼Œè½¬æ¢ä¸º P æ ¼å¼
                    const priorityNum = parseInt(priorityText) || 1;
                    priorityText = `P${priorityNum}`;
                }
                // ç¡®ä¿æ˜¯æœ‰æ•ˆçš„ä¼˜å…ˆçº§æ ¼å¼ï¼ˆP0, P1, P2ï¼‰
                if (!/^P[0-2]$/.test(priorityText)) {
                    priorityText = 'P1';
                }

                // åªè¦æœ‰ä»»åŠ¡åç§°å°±ä¿å­˜
                if (task) {
                    data.next_week_plan.push({
                        task: task,
                        priority: priorityText,  // ä¿æŒä¸ºå­—ç¬¦ä¸²æ ¼å¼ï¼ˆP0, P1, P2ï¼‰
                        goal: goal || ''        // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                    });
                }
            });

            return data;
        }

        // å¯ç”¨å†…è”ç¼–è¾‘
        function enableInlineEditing() {
            const editableElements = document.querySelectorAll('.editable-text');
            editableElements.forEach(element => {
                element.contentEditable = 'true';
                element.addEventListener('focus', handleEditStart);
                element.addEventListener('blur', handleEditEnd);
                element.addEventListener('keydown', handleKeyDown);
                element.addEventListener('input', handleInput);
            });

            const editableRows = document.querySelectorAll('.editable-row');
            editableRows.forEach(row => {
                row.addEventListener('click', handleRowClick);
            });

            const deleteButtons = document.querySelectorAll('.row-action-btn.delete');
            deleteButtons.forEach(button => {
                button.addEventListener('click', handleDeleteRow);
            });

            const addButtons = document.querySelectorAll('.add-row-btn');
            addButtons.forEach(button => {
                button.addEventListener('click', handleAddRow);
            });
        }

        // ç¦ç”¨å†…è”ç¼–è¾‘
        function disableInlineEditing() {
            const editingElements = document.querySelectorAll('.editable-text:focus');
            editingElements.forEach(element => {
                element.blur();
            });

            const editableElements = document.querySelectorAll('.editable-text');
            editableElements.forEach(element => {
                element.contentEditable = 'false';
                element.removeEventListener('focus', handleEditStart);
                element.removeEventListener('blur', handleEditEnd);
                element.removeEventListener('keydown', handleKeyDown);
                element.removeEventListener('input', handleInput);
            });

            const editableRows = document.querySelectorAll('.editable-row');
            editableRows.forEach(row => {
                row.removeEventListener('click', handleRowClick);
                row.classList.remove('selected');
            });
        }

        // å¤„ç†ç¼–è¾‘ç›¸å…³äº‹ä»¶
        function handleEditStart(e) {
            if (!isEditMode) return;
            const row = e.target.closest('.editable-row');
            if (row) {
                const allRows = document.querySelectorAll('.editable-row');
                allRows.forEach(r => r.classList.remove('selected'));
                row.classList.add('selected');
            }
        }

        function handleEditEnd(e) {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¿å­˜é€»è¾‘
        }

        function handleInput(e) {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å®æ—¶éªŒè¯
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                e.target.blur();
            }
            if (e.key === 'Escape') {
                e.target.blur();
            }
        }

        function handleRowClick(e) {
            if (!isEditMode) return;
            if (e.target.classList.contains('row-action-btn')) return;

            const allRows = document.querySelectorAll('.editable-row');
            allRows.forEach(row => row.classList.remove('selected'));
            e.currentTarget.classList.add('selected');
        }

        function handleDeleteRow(e) {
            e.stopPropagation();
            const row = e.target.closest('.editable-row');
            if (!row) return;

            const dataPath = row.getAttribute('data-path');
            const dataIndex = parseInt(row.getAttribute('data-index'));

            if (dataPath && dataIndex !== undefined) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ åˆ é™¤é€»è¾‘ï¼Œç°åœ¨åªæ˜¯ä»DOMä¸­ç§»é™¤
                row.remove();
                console.log(`Deleted ${dataPath}[${dataIndex}]`);
            }
        }

        function handleAddRow(e) {
            e.stopPropagation();
            const dataPath = e.target.getAttribute('data-path');
            if (!dataPath) return;

            let container;
            let newRow;
            let newIndex;

            switch(dataPath) {
                case 'completed_tasks':
                    container = document.getElementById('completed-tasks');
                    if (!container) return;
                    
                    // å¦‚æœè¡¨æ ¼ä¸å­˜åœ¨ï¼Œåˆ›å»ºè¡¨æ ¼
                    let tbody = container.querySelector('tbody');
                    if (!tbody) {
                        container.innerHTML = `
                            <table class="task-table">
                                <thead>
                                    <tr>
                                        <th>ä»»åŠ¡åç§°</th>
                                        <th>å®Œæˆæƒ…å†µ</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <button class="add-row-btn" data-path="completed_tasks">+ æ·»åŠ å®Œæˆä»»åŠ¡</button>
                        `;
                        tbody = container.querySelector('tbody');
                        // é‡æ–°ç»‘å®šæ·»åŠ æŒ‰é’®äº‹ä»¶
                        const newAddBtn = container.querySelector('.add-row-btn');
                        if (newAddBtn) {
                            newAddBtn.addEventListener('click', handleAddRow);
                        }
                    }
                    
                    newIndex = tbody.querySelectorAll('.editable-row').length;
                    
                    newRow = document.createElement('tr');
                    newRow.className = 'editable-row';
                    newRow.setAttribute('data-path', 'completed_tasks');
                    newRow.setAttribute('data-index', newIndex);
                    newRow.innerHTML = `
                        <td>
                            <div class="task-name editable-text" data-path="completed_tasks" data-index="${newIndex}" data-field="task" data-placeholder="ä»»åŠ¡åç§°"></div>
                        </td>
                        <td>
                            <div class="task-desc editable-text" data-path="completed_tasks" data-index="${newIndex}" data-field="description" data-placeholder="ä»»åŠ¡æè¿°"></div>
                        </td>
                        <td class="row-actions">
                            <button class="row-action-btn delete" title="åˆ é™¤">Ã—</button>
                        </td>
                    `;
                    tbody.appendChild(newRow);
                    break;

                case 'incomplete_tasks':
                    container = document.getElementById('not-completed-tasks');
                    if (!container) return;
                    
                    // å¦‚æœè¡¨æ ¼ä¸å­˜åœ¨ï¼Œåˆ›å»ºè¡¨æ ¼
                    let tbody2 = container.querySelector('tbody');
                    if (!tbody2) {
                        container.innerHTML = `
                            <table class="task-table">
                                <thead>
                                    <tr>
                                        <th>ä»»åŠ¡åç§°</th>
                                        <th>é¢„æœŸç›®æ ‡</th>
                                        <th>æœªå®ŒæˆåŸå› </th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <button class="add-row-btn" data-path="incomplete_tasks">+ æ·»åŠ æœªå®Œæˆä»»åŠ¡</button>
                        `;
                        tbody2 = container.querySelector('tbody');
                        // é‡æ–°ç»‘å®šæ·»åŠ æŒ‰é’®äº‹ä»¶
                        const newAddBtn2 = container.querySelector('.add-row-btn');
                        if (newAddBtn2) {
                            newAddBtn2.addEventListener('click', handleAddRow);
                        }
                    }
                    
                    newIndex = tbody2.querySelectorAll('.editable-row').length;
                    
                    newRow = document.createElement('tr');
                    newRow.className = 'editable-row';
                    newRow.setAttribute('data-path', 'incomplete_tasks');
                    newRow.setAttribute('data-index', newIndex);
                    newRow.innerHTML = `
                        <td>
                            <div class="task-name editable-text" data-path="incomplete_tasks" data-index="${newIndex}" data-field="task" data-placeholder="ä»»åŠ¡åç§°"></div>
                        </td>
                        <td>
                            <div class="task-desc editable-text" data-path="incomplete_tasks" data-index="${newIndex}" data-field="expected" data-placeholder="é¢„æœŸç›®æ ‡"></div>
                        </td>
                        <td>
                            <div class="task-desc editable-text" data-path="incomplete_tasks" data-index="${newIndex}" data-field="reason" data-placeholder="æœªå®ŒæˆåŸå› "></div>
                        </td>
                        <td class="row-actions">
                            <button class="row-action-btn delete" title="åˆ é™¤">Ã—</button>
                        </td>
                    `;
                    tbody2.appendChild(newRow);
                    break;

                case 'motivation_direction':
                    container = document.getElementById('reasons-list');
                    if (!container) return;
                    
                    // ç§»é™¤"æš‚æ— "æç¤º
                    const emptyMsg = container.querySelector('.text-muted');
                    if (emptyMsg) emptyMsg.remove();
                    
                    // ç¡®ä¿æœ‰æ·»åŠ æŒ‰é’®
                    let addBtn = container.querySelector('.add-row-btn');
                    if (!addBtn) {
                        addBtn = document.createElement('button');
                        addBtn.className = 'add-row-btn';
                        addBtn.setAttribute('data-path', 'motivation_direction');
                        addBtn.textContent = '+ æ·»åŠ åŠ¨æœºæ–¹å‘';
                        addBtn.addEventListener('click', handleAddRow);
                        container.appendChild(addBtn);
                    }
                    
                    newIndex = container.querySelectorAll('.editable-row').length;
                    
                    newRow = document.createElement('div');
                    newRow.className = 'data-item editable-row';
                    newRow.setAttribute('data-path', 'motivation_direction');
                    newRow.setAttribute('data-index', newIndex);
                    newRow.innerHTML = `
                        <span class="editable-text" data-path="motivation_direction" data-index="${newIndex}" data-field="item" data-placeholder="è¾“å…¥åŠ¨æœºæ–¹å‘"></span>
                        <div class="row-actions">
                            <button class="row-action-btn delete" title="åˆ é™¤">Ã—</button>
                        </div>
                    `;
                    // æ’å…¥åˆ°æ·»åŠ æŒ‰é’®ä¹‹å‰
                    container.insertBefore(newRow, addBtn);
                    break;

                case 'internal_reflection':
                    container = document.getElementById('why-not-list');
                    if (!container) return;
                    
                    const emptyMsg2 = container.querySelector('.text-muted');
                    if (emptyMsg2) emptyMsg2.remove();
                    
                    // ç¡®ä¿æœ‰æ·»åŠ æŒ‰é’®
                    let addBtn2 = container.querySelector('.add-row-btn');
                    if (!addBtn2) {
                        addBtn2 = document.createElement('button');
                        addBtn2.className = 'add-row-btn';
                        addBtn2.setAttribute('data-path', 'internal_reflection');
                        addBtn2.textContent = '+ æ·»åŠ å†…éƒ¨åæ€';
                        addBtn2.addEventListener('click', handleAddRow);
                        container.appendChild(addBtn2);
                    }
                    
                    newIndex = container.querySelectorAll('.editable-row').length;
                    
                    newRow = document.createElement('div');
                    newRow.className = 'data-item editable-row';
                    newRow.setAttribute('data-path', 'internal_reflection');
                    newRow.setAttribute('data-index', newIndex);
                    newRow.innerHTML = `
                        <span class="editable-text" data-path="internal_reflection" data-index="${newIndex}" data-field="item" data-placeholder="è¾“å…¥å†…éƒ¨åæ€"></span>
                        <div class="row-actions">
                            <button class="row-action-btn delete" title="åˆ é™¤">Ã—</button>
                        </div>
                    `;
                    container.insertBefore(newRow, addBtn2);
                    break;

                case 'external_feedback':
                    container = document.getElementById('achievements-list');
                    if (!container) return;
                    
                    const emptyMsg3 = container.querySelector('.text-muted');
                    if (emptyMsg3) emptyMsg3.remove();
                    
                    // ç¡®ä¿æœ‰æ·»åŠ æŒ‰é’®
                    let addBtn3 = container.querySelector('.add-row-btn');
                    if (!addBtn3) {
                        addBtn3 = document.createElement('button');
                        addBtn3.className = 'add-row-btn';
                        addBtn3.setAttribute('data-path', 'external_feedback');
                        addBtn3.textContent = '+ æ·»åŠ å¤–éƒ¨åé¦ˆ';
                        addBtn3.addEventListener('click', handleAddRow);
                        container.appendChild(addBtn3);
                    }
                    
                    newIndex = container.querySelectorAll('.editable-row').length;
                    
                    newRow = document.createElement('div');
                    newRow.className = 'data-item editable-row';
                    newRow.setAttribute('data-path', 'external_feedback');
                    newRow.setAttribute('data-index', newIndex);
                    newRow.innerHTML = `
                        <div class="task-name editable-text" data-path="external_feedback" data-index="${newIndex}" data-field="source" data-placeholder="åé¦ˆæ¥æº"></div>
                        <div class="task-desc editable-text" data-path="external_feedback" data-index="${newIndex}" data-field="content" data-placeholder="åé¦ˆå†…å®¹"></div>
                        <div class="row-actions">
                            <button class="row-action-btn delete" title="åˆ é™¤">Ã—</button>
                        </div>
                    `;
                    container.insertBefore(newRow, addBtn3);
                    break;

                case 'next_week_plan':
                    container = document.getElementById('next-steps-list');
                    if (!container) return;
                    
                    // å¦‚æœè¡¨æ ¼ä¸å­˜åœ¨ï¼Œåˆ›å»ºè¡¨æ ¼
                    let tbody3 = container.querySelector('tbody');
                    if (!tbody3) {
                        container.innerHTML = `
                            <table class="task-table">
                                <thead>
                                    <tr>
                                        <th>ä¼˜å…ˆçº§</th>
                                        <th>ä»»åŠ¡åç§°</th>
                                        <th>ç›®æ ‡</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <button class="add-row-btn" data-path="next_week_plan">+ æ·»åŠ ä¸‹ä¸€æ­¥è®¡åˆ’</button>
                        `;
                        tbody3 = container.querySelector('tbody');
                        // é‡æ–°ç»‘å®šæ·»åŠ æŒ‰é’®äº‹ä»¶
                        const newAddBtn3 = container.querySelector('.add-row-btn');
                        if (newAddBtn3) {
                            newAddBtn3.addEventListener('click', handleAddRow);
                        }
                    }
                    
                    newIndex = tbody3.querySelectorAll('.editable-row').length;
                    
                    newRow = document.createElement('tr');
                    newRow.className = 'editable-row';
                    newRow.setAttribute('data-path', 'next_week_plan');
                    newRow.setAttribute('data-index', newIndex);
                    newRow.innerHTML = `
                        <td>
                            <span class="priority-badge editable-text" data-path="next_week_plan" data-index="${newIndex}" data-field="priority" data-placeholder="P1">P1</span>
                        </td>
                        <td>
                            <div class="task-name editable-text" data-path="next_week_plan" data-index="${newIndex}" data-field="task" data-placeholder="ä»»åŠ¡åç§°"></div>
                        </td>
                        <td>
                            <div class="task-desc editable-text" data-path="next_week_plan" data-index="${newIndex}" data-field="goal" data-placeholder="ç›®æ ‡æè¿°"></div>
                        </td>
                        <td class="row-actions">
                            <button class="row-action-btn delete" title="åˆ é™¤">Ã—</button>
                        </td>
                    `;
                    tbody3.appendChild(newRow);
                    break;
            }

            // é‡æ–°ç»‘å®šç¼–è¾‘äº‹ä»¶åˆ°æ–°æ·»åŠ çš„è¡Œï¼ˆå¿…é¡»åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼‰
            if (isEditMode && newRow) {
                const editableElements = newRow.querySelectorAll('.editable-text');
                editableElements.forEach(element => {
                    element.contentEditable = 'true';
                    element.addEventListener('focus', handleEditStart);
                    element.addEventListener('blur', handleEditEnd);
                    element.addEventListener('keydown', handleKeyDown);
                    element.addEventListener('input', handleInput);
                });

                const deleteBtn = newRow.querySelector('.row-action-btn.delete');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', handleDeleteRow);
                }

                newRow.addEventListener('click', handleRowClick);
                
                // è‡ªåŠ¨èšç„¦åˆ°ç¬¬ä¸€ä¸ªå¯ç¼–è¾‘å­—æ®µ
                const firstEditable = newRow.querySelector('.editable-text');
                if (firstEditable) {
                    setTimeout(() => firstEditable.focus(), 100);
                }
            } else {
                // å¦‚æœä¸åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œæç¤ºç”¨æˆ·è¿›å…¥ç¼–è¾‘æ¨¡å¼
                showToast('è¯·å…ˆè¿›å…¥ç¼–è¾‘æ¨¡å¼', 'info');
            }
        }

        // ç»´åº¦åˆ‡æ¢
        function toggleDimension(button) {
            const sectionName = button.getAttribute('data-section');
            const section = document.querySelector(`.report-section[data-section="${sectionName}"]`);

            if (section) {
                section.classList.toggle('hidden');
                button.classList.toggle('active');
            }
        }

        // ç»´åº¦æ§åˆ¶åŒºåŸŸåˆ‡æ¢
        function toggleDimensionControls() {
            const controls = document.querySelector('.dimension-controls');
            controls.classList.toggle('hidden');
        }

        // åˆå§‹åŒ–åé¦ˆæŒ‰é’®
        function initializeFeedbackButtons() {
            const sections = ['motivation', 'completed', 'incomplete', 'internal', 'external', 'next-steps'];
            sections.forEach(section => {
                const feedbackContainer = document.getElementById(`feedback-${section}`);
                if (feedbackContainer) {
                    const thumbsUpSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M7 10v12m8-8.5V2c0-.83-.67-1.5-1.5-1.5h-.5a2 2 0 0 0-2 2v7H2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2z"></path>
                    </svg>`;

                    const thumbsDownSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 14V2m-8 8.5v11.5c0 .83.67 1.5 1.5 1.5h.5a2 2 0 0 1 2-2v-7h7a2 2 0 0 1 2-2v-8a2 2 0 0 1-2-2h-12a2 2 0 0 1-2 2v8a2 2 0 0 1 2 2z"></path>
                    </svg>`;

                    feedbackContainer.innerHTML = `
                        <button class="feedback-btn" onclick="giveFeedback('${section}', 'like')" title="æœ‰å¸®åŠ©">
                            ${thumbsUpSvg}
                        </button>
                        <button class="feedback-btn" onclick="giveFeedback('${section}', 'dislike')" title="æ²¡å¸®åŠ©">
                            ${thumbsDownSvg}
                        </button>
                    `;
                }
            });
        }

        // åé¦ˆåŠŸèƒ½
        function giveFeedback(sectionName, feedbackType) {
            const section = document.querySelector(`.report-section[data-section="${sectionName}"]`);
            if (!section) return;

            const likeBtn = section.querySelector('.feedback-btn[onclick*="like"]');
            const dislikeBtn = section.querySelector('.feedback-btn[onclick*="dislike"]');

            likeBtn.classList.remove('liked');
            dislikeBtn.classList.remove('disliked');

            if (feedbackType === 'like') {
                likeBtn.classList.add('liked');
                console.log(`ç”¨æˆ·å¯¹ ${sectionName} ç»´åº¦ç‚¹èµ`);
            } else if (feedbackType === 'dislike') {
                dislikeBtn.classList.add('disliked');
                console.log(`ç”¨æˆ·å¯¹ ${sectionName} ç»´åº¦ç‚¹è¸©`);
            }

            showFeedbackToast();
            if (event) event.stopPropagation();
        }

        // æ˜¾ç¤ºåé¦ˆæç¤º
        function showFeedbackToast() {
            const existingToast = document.querySelector('.feedback-toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'feedback-toast';
            toast.textContent = 'Thank you for your feedback';
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 2000);
        }

        // é€šç”¨ Toast é€šçŸ¥å‡½æ•°
        function showToast(message, type = 'info', duration = 3000) {
            // è·å–æ‰€æœ‰ç°æœ‰çš„ toast
            const existingToasts = document.querySelectorAll('.toast');
            const toastCount = existingToasts.length;

            // åˆ›å»ºæ–°çš„ toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            // è®¡ç®—ä½ç½®ï¼ˆå¤šä¸ª toast å †å æ˜¾ç¤ºï¼‰
            const topOffset = 20 + (toastCount * 70); // æ¯ä¸ª toast é—´éš” 70px
            toast.style.top = `${topOffset}px`;
            
            document.body.appendChild(toast);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in';
                setTimeout(() => {
                    toast.remove();
                    // é‡æ–°è°ƒæ•´å‰©ä½™ toast çš„ä½ç½®
                    const remainingToasts = document.querySelectorAll('.toast');
                    remainingToasts.forEach((remainingToast, index) => {
                        remainingToast.style.top = `${20 + index * 70}px`;
                    });
                }, 300);
            }, duration);

            return toast;
        }

        // ç¼–è¾‘çŠ¶æ€
        function editStatus(cellElement, event) {
            if (event) {
                event.stopPropagation();
            }

            const currentText = cellElement.textContent;
            const projectId = cellElement.getAttribute('data-project');

            cellElement.classList.add('editing');
            cellElement.contentEditable = 'true';
            cellElement.focus();

            // é€‰ä¸­æ‰€æœ‰æ–‡æœ¬
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(cellElement);
            selection.removeAllRanges();
            selection.addRange(range);

            async function saveEdit() {
                const newText = cellElement.textContent.trim();
                if (newText && newText !== currentText) {
                    try {
                        // è°ƒç”¨APIä¿å­˜çŠ¶æ€æ›´æ–°
                        const response = await apiCall(`/projects/${projectId}/status`, {
                            method: 'PUT',
                            body: JSON.stringify({ status: newText })
                        });
                        if (response && response.success) {
                            cellElement.textContent = newText;
                            console.log(`Status updated for ${projectId}: ${newText}`);
                            showToast('çŠ¶æ€æ›´æ–°æˆåŠŸ', 'success');
                        } else {
                            cellElement.textContent = currentText;
                            showToast('çŠ¶æ€æ›´æ–°å¤±è´¥', 'error');
                        }
                    } catch (error) {
                        console.error('Failed to update status:', error);
                        cellElement.textContent = currentText;
                        showToast('çŠ¶æ€æ›´æ–°å¤±è´¥', 'error');
                    }
                } else {
                    cellElement.textContent = currentText;
                }
                cellElement.classList.remove('editing');
                cellElement.contentEditable = 'false';
            }

            function cancelEdit() {
                cellElement.textContent = currentText;
                cellElement.classList.remove('editing');
                cellElement.contentEditable = 'false';
            }

            cellElement.addEventListener('blur', saveEdit, { once: true });
            cellElement.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    cancelEdit();
                }
            }, { once: true });

            cellElement.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // æ–‡ä»¶é€‰æ‹©ç›‘å¬
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length > 0) {
                const folderPath = files[0].webkitRelativePath.split('/')[0];
                document.getElementById('fileName').textContent = `æ–‡ä»¶å¤¹: ${folderPath}`;

                // æ˜¾ç¤ºæ–‡ä»¶å¤¹ç»“æ„ï¼ˆä¼šè‡ªåŠ¨åŒ…å«æ‰‹åŠ¨æ·»åŠ çš„æ–‡æ¡£ï¼‰
                displayFolderStructure(files);
            } else {
                document.getElementById('fileName').textContent = 'æœªé€‰æ‹©';
                // å¦‚æœè¿˜æœ‰æ‰‹åŠ¨æ–‡æ¡£ï¼Œä»ç„¶æ˜¾ç¤º
                if (manualDocuments && manualDocuments.length > 0) {
                    updateManualDocumentsDisplay();
                } else {
                hideFolderStructure();
                }
            }
        });

        // æ„å»ºæ–‡ä»¶å¤¹æ ‘ç»“æ„
        function buildFolderTree(files) {
            const tree = {};

            Array.from(files).forEach(file => {
                // è¿‡æ»¤æ‰ç³»ç»Ÿæ–‡ä»¶å’Œéšè—æ–‡ä»¶
                if (file.name.startsWith('.') ||
                    file.name === '.DS_Store' ||
                    file.name === 'Thumbs.db' ||
                    file.name === 'desktop.ini') {
                    return;
                }

                const path = file.webkitRelativePath;
                const parts = path.split('/');
                let current = tree;

                parts.forEach((part, index) => {
                    // è¿‡æ»¤æ‰éšè—æ–‡ä»¶å¤¹
                    if (part.startsWith('.')) {
                        return;
                    }

                    if (!current[part]) {
                        current[part] = {
                            type: index === parts.length - 1 ? 'file' : 'folder',
                            children: {},
                            file: index === parts.length - 1 ? file : null
                        };
                    }
                    current = current[part].children;
                });
            });

            return tree;
        }

        // ç”Ÿæˆæ ‘çŠ¶ç»“æ„çš„HTML
        function generateTreeHTML(tree, prefix = '') {
            let html = '';

            Object.keys(tree).sort().forEach(name => {
                const item = tree[name];
                const fileName = name.toLowerCase();
                const isTextFile = item.type === 'file' && (
                    fileName.endsWith('.html') || 
                    fileName.endsWith('.htm') || 
                    fileName.endsWith('.txt') || 
                    fileName.endsWith('.md')
                );
                const isFolder = item.type === 'folder';

                if (isFolder) {
                    // æ–‡ä»¶å¤¹
                    html += `
                        <div class="folder-item folder" onclick="toggleFolder(this)">
                            <span class="folder-toggle collapsed"></span>
                            ğŸ“ ${name}
                        </div>
                        <div class="folder-children" style="display: none;">
                            ${generateTreeHTML(item.children, prefix + '  ')}
                        </div>
                    `;
                } else if (isTextFile) {
                    // HTMLæ–‡ä»¶æˆ–å…¶ä»–æ–‡æœ¬æ–‡ä»¶
                    const displayName = cleanNotionFilename(name);
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ‰‹åŠ¨æ·»åŠ çš„æ–‡æ¡£
                    const fileData = item.file;
                    const isManual = fileData && fileData.isManual;
                    const fileItemAttr = isManual ? `data-file-item='${JSON.stringify(fileData).replace(/'/g, "&apos;")}'` : '';
                    html += `<div class="folder-item file html" onclick="showFileContent('${name}', this)" data-file="${name}" ${fileItemAttr} title="${name}">ğŸ“„ ${displayName}</div>`;
                } else {
                    // å…¶ä»–æ–‡ä»¶
                    html += `<div class="folder-item file">ğŸ“„ ${name}</div>`;
                }
            });

            return html;
        }

        // åˆ‡æ¢æ–‡ä»¶å¤¹å±•å¼€/æŠ˜å 
        function toggleFolder(element) {
            const toggle = element.querySelector('.folder-toggle');
            const children = element.nextElementSibling;

            if (children.style.display === 'none') {
                children.style.display = 'block';
                toggle.classList.remove('collapsed');
                toggle.classList.add('expanded');
            } else {
                children.style.display = 'none';
                toggle.classList.remove('expanded');
                toggle.classList.add('collapsed');
            }
        }

        // æ˜¾ç¤ºæ–‡ä»¶å†…å®¹
        function showFileContent(filename, element) {
            // ä½¿ç”¨æ¸…ç†åçš„æ˜¾ç¤ºåç§°
            const displayName = cleanNotionFilename(filename);

            // æ£€æŸ¥æ˜¯å¦æ˜¯æ‰‹åŠ¨æ·»åŠ çš„æ–‡æ¡£ï¼ˆé€šè¿‡æŸ¥æ‰¾æ‰‹åŠ¨æ–‡æ¡£åˆ—è¡¨ï¼‰
            if (manualDocuments && manualDocuments.length > 0) {
                const fileNameWithoutExt = filename.replace(/\.(html|htm|txt|md)$/i, '');
                const manualDoc = manualDocuments.find(doc => {
                    const docFileName = doc.title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                    return docFileName === fileNameWithoutExt;
                });
                
                if (manualDoc) {
                    showDialog(displayName, manualDoc.content);
                    return;
                }
            }

            // è¯»å–æ–‡ä»¶å†…å®¹å¹¶æ˜¾ç¤º
            const fileInput = document.getElementById('fileInput');
            const files = Array.from(fileInput.files);
            const file = files.find(f => f.name === filename);

            if (file && filename.toLowerCase().endsWith('.html')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    showDialog(displayName, e.target.result);
                };
                reader.readAsText(file);
            } else {
                showDialog(displayName, `<p>æ— æ³•é¢„è§ˆæ­¤æ–‡ä»¶ç±»å‹</p>`);
            }
        }

        // æ˜¾ç¤ºæ–‡ä»¶å¤¹ç»“æ„
        function displayFolderStructure(files) {
            const structureCard = document.getElementById('folderStructureCard');
            const structureContainer = document.getElementById('folderStructure');

            // æ„å»ºæ–‡ä»¶å¤¹æ ‘ç»“æ„
            const tree = buildFolderTree(files);

            // å¦‚æœæœ‰æ‰‹åŠ¨æ·»åŠ çš„æ–‡æ¡£ï¼Œæ·»åŠ åˆ°æ ‘ç»“æ„ä¸­
            if (manualDocuments && manualDocuments.length > 0) {
                if (!tree['å…¶ä»–æ–‡æ¡£']) {
                    tree['å…¶ä»–æ–‡æ¡£'] = {
                        type: 'folder',
                        children: {},
                        file: null
                    };
                }
                
                manualDocuments.forEach((doc, index) => {
                    const fileName = doc.title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_') + '.html';
                    tree['å…¶ä»–æ–‡æ¡£'].children[fileName] = {
                        type: 'file',
                        children: {},
                        file: {
                            name: fileName,
                            content: doc.content,
                            isManual: true
                        }
                    };
                });
            }

            // ç”ŸæˆHTML
            const html = generateTreeHTML(tree);
            structureContainer.innerHTML = html;

            // æ˜¾ç¤ºæ–‡ä»¶å¤¹ç»“æ„å¡ç‰‡
            structureCard.style.display = 'block';
        }

        // éšè—æ–‡ä»¶å¤¹ç»“æ„
        function hideFolderStructure() {
            const structureCard = document.getElementById('folderStructureCard');
            structureCard.style.display = 'none';
        }

        // æ¸…ç†Notionæ–‡ä»¶åï¼Œå»æ‰IDéƒ¨åˆ†
        function cleanNotionFilename(filename) {
            // å»æ‰.htmlåç¼€
            let name = filename.replace('.html', '');

            // Notionæ–‡ä»¶åé€šå¸¸åŒ…å«32ä½åå…­è¿›åˆ¶IDï¼Œæˆ‘ä»¬éœ€è¦å»æ‰è¿™äº›ID
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç›´æ¥æ›¿æ¢æ‰æ‰€æœ‰32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²
            const idPattern = /[a-f0-9]{32}/gi; // åŒ¹é…32ä½åå…­è¿›åˆ¶IDï¼ˆå»æ‰è¾¹ç•ŒåŒ¹é…ï¼‰

            // ç›´æ¥æ›¿æ¢æ‰æ‰€æœ‰IDï¼Œä¿ç•™å…¶ä»–å†…å®¹
            name = name.replace(idPattern, '').trim();

            // æ¸…ç†å¤šä½™çš„ç©ºæ ¼ï¼ˆå¤šä¸ªè¿ç»­ç©ºæ ¼å˜æˆå•ä¸ªç©ºæ ¼ï¼‰
            name = name.replace(/\s+/g, ' ').trim();

            // å¦‚æœæ¸…ç†åæ–‡ä»¶åå¤ªçŸ­æˆ–ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤åç§°
            if (!name || name.length < 2) {
                name = 'æœªå‘½åæ–‡æ¡£';
            }

            return name;
        }

        // æ˜¾ç¤ºä¾§è¾¹æ æ–‡ä»¶å¤¹ç»“æ„ï¼ˆä»åç«¯è·å–çœŸå®æ–‡ä»¶åˆ—è¡¨ï¼‰
        async function displaySidebarFolderStructure(projectId, week) {
            const sidebarContainer = document.getElementById('sidebarFolderStructure');

            try {
                // ä»åç«¯è·å–æ–‡ä»¶åˆ—è¡¨
                const response = await fetch(`${API_BASE_URL}/projects/${projectId}/week/${week}/files`);
                const data = await response.json();

                if (response.ok) {
                    const files = data.files || [];

                    // æ„å»ºæ–‡ä»¶å¤¹ç»“æ„ï¼ˆå’Œä¸‹æ–¹æ–‡ä»¶å¤¹ç»“æ„æ˜¾ç¤ºä¸€è‡´ï¼‰
                    // ç”±äºåç«¯è¿”å›çš„æ˜¯å¹³é“ºæ–‡ä»¶åˆ—è¡¨ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®æ–‡ä»¶åæ¨æ–­ç»“æ„
                    // å¯¹äºæ‰‹åŠ¨æ·»åŠ çš„æ–‡æ¡£ï¼Œæ–‡ä»¶åæ ¼å¼é€šå¸¸æ˜¯ title_xxx.html
                    // æˆ‘ä»¬å¯ä»¥å°è¯•è¯†åˆ«ï¼Œä½†æ›´ç®€å•çš„æ–¹å¼æ˜¯æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶åœ¨"å…¶ä»–æ–‡æ¡£"ä¸‹
                    // æˆ–è€…æ˜¾ç¤ºä¸ºå¹³é“ºç»“æ„ï¼Œä½†æ·»åŠ "å…¶ä»–æ–‡æ¡£"æ–‡ä»¶å¤¹
                    
                    // å…ˆå°è¯•æ ¹æ®æ–‡ä»¶è·¯å¾„æ„å»ºæ ‘ç»“æ„ï¼ˆå¦‚æœæœ‰è·¯å¾„ä¿¡æ¯ï¼‰
                    // å¦‚æœæ²¡æœ‰è·¯å¾„ä¿¡æ¯ï¼Œå°±æ˜¾ç¤ºä¸ºå¹³é“ºç»“æ„ï¼Œä½†æ·»åŠ "å…¶ä»–æ–‡æ¡£"åˆ†ç»„
                    const weekFolderName = 'ç¬¬' + week + 'å‘¨æ–‡ä»¶';
                    const tree = {};
                    tree[weekFolderName] = {
                        type: 'folder',
                        children: {},
                        file: null
                    };

                    // å°†æ‰€æœ‰æ–‡ä»¶æ·»åŠ åˆ°"å…¶ä»–æ–‡æ¡£"æ–‡ä»¶å¤¹ä¸‹
                    if (files.length > 0) {
                        tree[weekFolderName].children['å…¶ä»–æ–‡æ¡£'] = {
                            type: 'folder',
                            children: {},
                            file: null
                        };
                        
                        files.forEach(file => {
                            tree[weekFolderName].children['å…¶ä»–æ–‡æ¡£'].children[file] = {
                                type: 'file',
                                children: {},
                                file: null
                            };
                        });
                    }

                    // ç”ŸæˆHTMLï¼ˆä½¿ç”¨ä¸ä¸‹æ–¹æ–‡ä»¶å¤¹ç»“æ„ç›¸åŒçš„ç”Ÿæˆå‡½æ•°ï¼‰
                    const html = generateSidebarTreeHTML(tree);
                    sidebarContainer.innerHTML = html;
                } else {
                    console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', data);
                    sidebarContainer.innerHTML = '<div class="folder-item" style="color: #999; font-style: italic;">åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('è·å–æ–‡ä»¶åˆ—è¡¨å‡ºé”™:', error);
                sidebarContainer.innerHTML = '<div class="folder-item" style="color: #999; font-style: italic;">åŠ è½½å¤±è´¥</div>';
            }
        }

        // ç”Ÿæˆä¾§è¾¹æ æ ‘çŠ¶ç»“æ„çš„HTMLï¼ˆç®€åŒ–ç‰ˆï¼Œæ”¯æŒæ–‡ä»¶å¤¹å’Œæ–‡ä»¶ï¼‰
        function generateSidebarTreeHTML(tree, prefix = '') {
            let html = '';

            Object.keys(tree).sort().forEach(name => {
                const item = tree[name];
                const isFolder = item.type === 'folder';

                if (isFolder) {
                    // æ–‡ä»¶å¤¹
                    html += `
                        <div class="folder-item folder" onclick="toggleSidebarFolder(this)">
                            <span class="folder-toggle collapsed"></span>
                            ğŸ“ ${name}
                        </div>
                        <div class="folder-children" style="display: none;">
                            ${generateSidebarTreeHTML(item.children, prefix + '  ')}
                        </div>
                    `;
                } else {
                    // æ–‡ä»¶
                    const fileName = name.toLowerCase();
                    const isTextFile = fileName.endsWith('.html') || fileName.endsWith('.htm') || fileName.endsWith('.txt') || fileName.endsWith('.md');
                    if (isTextFile) {
                        const displayName = name.replace(/\.(html|htm|txt|md)$/i, '');
                        // è·å–é¡¹ç›®IDå’Œå‘¨æ•°ï¼ˆä»å…¨å±€å˜é‡æˆ–é€šè¿‡å…¶ä»–æ–¹å¼ï¼‰
                        const projectId = currentProject;
                        const week = currentWeek;
                        html += `<div class="folder-item file html" onclick="showSidebarFileContent('${name}', ${week}, '${projectId}')" title="${name}">ğŸ“„ ${displayName}</div>`;
                    } else {
                        html += `<div class="folder-item file">ğŸ“„ ${name}</div>`;
                    }
                }
            });

            return html;
        }

        // åˆ‡æ¢ä¾§è¾¹æ æ–‡ä»¶å¤¹å±•å¼€/æŠ˜å 
        function toggleSidebarFolder(element) {
            const toggle = element.querySelector('.folder-toggle');
            const children = element.nextElementSibling;

            if (children.style.display === 'none') {
                children.style.display = 'block';
                toggle.classList.remove('collapsed');
                toggle.classList.add('expanded');
            } else {
                children.style.display = 'none';
                toggle.classList.remove('expanded');
                toggle.classList.add('collapsed');
            }
        }

        // æ˜¾ç¤ºå¯¹è¯æ¡†
        function showDialog(title, content) {
            // ç§»é™¤å·²å­˜åœ¨çš„å¯¹è¯æ¡†
            const existingDialog = document.querySelector('.dialog-overlay');
            if (existingDialog) {
                existingDialog.remove();
            }

            // åˆ›å»ºå¯¹è¯æ¡†HTML
            const dialogHTML = `
                <div class="dialog-overlay" onclick="closeDialog()">
                    <div class="dialog" onclick="event.stopPropagation()">
                        <div class="dialog-header">
                            <h3 class="dialog-title">${title}</h3>
                            <button class="dialog-close" onclick="closeDialog()">Ã—</button>
                        </div>
                        <div class="dialog-content">
                            <div>
                                ${content}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
        }

        // å…³é—­å¯¹è¯æ¡†
        function closeDialog() {
            const dialog = document.querySelector('.dialog-overlay');
            if (dialog) {
                dialog.remove();
            }
        }

        // æ˜¾ç¤ºæ·»åŠ æ–‡æ¡£å¯¹è¯æ¡†
        function showAddDocumentDialog() {
            // ç§»é™¤å·²å­˜åœ¨çš„å¯¹è¯æ¡†
            const existingDialog = document.querySelector('.dialog-overlay');
            if (existingDialog) {
                existingDialog.remove();
            }

            // åˆ›å»ºå¯¹è¯æ¡†HTML
            const dialogHTML = `
                <div class="dialog-overlay" onclick="closeAddDocumentDialog()">
                    <div class="dialog dialog-add-document" onclick="event.stopPropagation()" style="max-width: 800px; max-height: 80vh;">
                        <div class="dialog-header">
                            <h3 class="dialog-title">æ·»åŠ æ–‡æ¡£</h3>
                            <button class="dialog-close" onclick="closeAddDocumentDialog()">Ã—</button>
                        </div>
                        <div class="dialog-content">
                            <div class="dialog-form">
                                <div class="dialog-form-content">
                                    <label for="docTitle">æ–‡æ¡£æ ‡é¢˜</label>
                                    <input type="text" id="docTitle" placeholder="è¾“å…¥æ–‡æ¡£æ ‡é¢˜" value="">
                                    
                                    <label for="docContent">æ–‡æ¡£å†…å®¹</label>
                                    <textarea id="docContent" placeholder="åœ¨æ­¤ç²˜è´´æˆ–è¾“å…¥æ–‡æ¡£å†…å®¹..."></textarea>
                                </div>
                                <div class="dialog-actions">
                                    <button class="btn" onclick="closeAddDocumentDialog()">å–æ¶ˆ</button>
                                    <button class="btn primary" onclick="saveManualDocument()">ä¿å­˜</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
            
            // èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
            setTimeout(() => {
                const titleInput = document.getElementById('docTitle');
                if (titleInput) {
                    titleInput.focus();
                }
            }, 100);
        }

        // å…³é—­æ·»åŠ æ–‡æ¡£å¯¹è¯æ¡†
        function closeAddDocumentDialog() {
            const dialog = document.querySelector('.dialog-overlay');
            if (dialog) {
                dialog.remove();
            }
        }

        // ä¿å­˜æ‰‹åŠ¨æ·»åŠ çš„æ–‡æ¡£
        function saveManualDocument() {
            const titleInput = document.getElementById('docTitle');
            const contentInput = document.getElementById('docContent');

            if (!titleInput || !contentInput) {
                return;
            }

            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (!title) {
                showToast('è¯·è¾“å…¥æ–‡æ¡£æ ‡é¢˜', 'warning');
                titleInput.focus();
                return;
            }

            if (!content) {
                showToast('è¯·è¾“å…¥æ–‡æ¡£å†…å®¹', 'warning');
                contentInput.focus();
                return;
            }

            // æ·»åŠ åˆ°æ‰‹åŠ¨æ–‡æ¡£åˆ—è¡¨
            manualDocuments.push({
                title: title,
                content: content
            });

            showToast(`æ–‡æ¡£"${title}"å·²æ·»åŠ `, 'success');
            closeAddDocumentDialog();
            
            // æ›´æ–°å·²æ·»åŠ æ–‡æ¡£åˆ—è¡¨æ˜¾ç¤º
            updateManualDocumentsDisplay();
        }

        // æ›´æ–°æ‰‹åŠ¨æ·»åŠ æ–‡æ¡£çš„æ˜¾ç¤º
        function updateManualDocumentsDisplay() {
            // æ›´æ–°æ–‡ä»¶å¤¹ç»“æ„æ˜¾ç¤ºï¼ˆå¦‚æœæ–‡ä»¶é€‰æ‹©ä¸ä¸ºç©ºï¼‰
            const fileInput = document.getElementById('fileInput');
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                displayFolderStructure(fileInput.files);
            } else if (manualDocuments.length > 0) {
                // å¦‚æœåªæœ‰æ‰‹åŠ¨æ–‡æ¡£ï¼Œä¹Ÿæ˜¾ç¤ºæ–‡ä»¶å¤¹ç»“æ„
                const structureCard = document.getElementById('folderStructureCard');
                const structureContainer = document.getElementById('folderStructure');
                if (structureCard && structureContainer) {
                    // æ„å»ºåªæœ‰æ‰‹åŠ¨æ–‡æ¡£çš„æ ‘ç»“æ„
                    const tree = {
                        'å…¶ä»–æ–‡æ¡£': {
                            type: 'folder',
                            children: {},
                            file: null
                        }
                    };
                    
                    manualDocuments.forEach((doc, index) => {
                        const fileName = doc.title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_') + '.html';
                        tree['å…¶ä»–æ–‡æ¡£'].children[fileName] = {
                            type: 'file',
                            children: {},
                            file: {
                                name: fileName,
                                content: doc.content,
                                isManual: true
                            }
                        };
                    });
                    
                    const html = generateTreeHTML(tree);
                    structureContainer.innerHTML = html;
                    structureCard.style.display = 'block';
                }
            } else {
                // å¦‚æœæ²¡æœ‰æ‰‹åŠ¨æ–‡æ¡£ï¼Œéšè—æ–‡ä»¶å¤¹ç»“æ„
                const structureCard = document.getElementById('folderStructureCard');
                if (structureCard) {
                    structureCard.style.display = 'none';
                }
            }
        }

        // åˆ é™¤æ‰‹åŠ¨æ·»åŠ çš„æ–‡æ¡£
        function removeManualDocument(index) {
            if (index >= 0 && index < manualDocuments.length) {
                const doc = manualDocuments[index];
                manualDocuments.splice(index, 1);
                showToast(`æ–‡æ¡£"${doc.title}"å·²åˆ é™¤`, 'success');
                // æ›´æ–°æ˜¾ç¤ºï¼ˆä¼šé‡æ–°æ„å»ºæ–‡ä»¶å¤¹ç»“æ„ï¼‰
                const fileInput = document.getElementById('fileInput');
                if (fileInput && fileInput.files && fileInput.files.length > 0) {
                    displayFolderStructure(fileInput.files);
                } else {
                    updateManualDocumentsDisplay();
                }
            }
        }

        // æ˜¾ç¤ºä¾§è¾¹æ æ–‡ä»¶å†…å®¹
        async function showSidebarFileContent(filename, week, projectId) {
            // APIè¿”å›çš„æ–‡ä»¶åå·²ç»æ˜¯æ¸…ç†è¿‡çš„ï¼Œç›´æ¥å»æ‰.htmlåç¼€ä½œä¸ºæ˜¾ç¤ºåç§°
            const displayName = filename.replace('.html', '');

            try {
                // ä»åç«¯è·å–æ–‡ä»¶å†…å®¹
                const response = await fetch(`${API_BASE_URL}/projects/${projectId}/week/${week}/files/${filename}`);
                if (response.ok) {
                    const content = await response.text();
                    showDialog(displayName, content);
                } else {
                    // å¦‚æœAPIä¸å­˜åœ¨ï¼Œä½¿ç”¨mockå†…å®¹ä½œä¸ºåå¤‡
                    console.warn('æ–‡ä»¶å†…å®¹APIä¸å­˜åœ¨ï¼Œä½¿ç”¨mockå†…å®¹');
                    const mockContent = generateSidebarFileContent(filename, week);
                    showDialog(displayName, mockContent);
                }
            } catch (error) {
                console.error('è·å–æ–‡ä»¶å†…å®¹å‡ºé”™:', error);
                // ä½¿ç”¨mockå†…å®¹ä½œä¸ºåå¤‡
                const mockContent = generateSidebarFileContent(filename, week);
                showDialog(displayName, mockContent);
            }
        }

        // ç”Ÿæˆä¾§è¾¹æ æ–‡ä»¶å†…å®¹
        function generateSidebarFileContent(filename, week) {
            const baseName = filename.replace('.html', '');

            // æ ¹æ®æ–‡ä»¶åå’Œå‘¨æ•°ç”Ÿæˆä¸åŒçš„å†…å®¹
            if (week === 1) {
                switch (baseName) {
                    case 'åŸå‹å›¾':
                        return `<h2>ç¬¬${week}å‘¨ - ${baseName}</h2><p>é¡¹ç›®åŸå‹è®¾è®¡ï¼ŒåŒ…å«ä¸»è¦åŠŸèƒ½æµç¨‹å’Œç”¨æˆ·äº¤äº’è¯´æ˜ã€‚</p>`;
                    case 'è®¾è®¡å›¾':
                        return `<h2>ç¬¬${week}å‘¨ - ${baseName}</h2><p>UIè®¾è®¡ç³»ç»Ÿï¼Œè‰²å½©æ­é…å’Œç»„ä»¶è§„èŒƒã€‚</p>`;
                    case 'äº§å“æ–‡æ¡£':
                        return `<h2>ç¬¬${week}å‘¨ - ${baseName}</h2><p>äº§å“éœ€æ±‚æ–‡æ¡£å’ŒåŠŸèƒ½è§„æ ¼è¯´æ˜ã€‚</p>`;
                }
            } else if (week === 2) {
                switch (baseName) {
                    case 'æ›´æ–°æ–‡æ¡£':
                        return `<h2>ç¬¬${week}å‘¨ - ${baseName}</h2><p>é¡¹ç›®æ›´æ–°æ—¥å¿—å’ŒåŠŸèƒ½æ”¹è¿›è®°å½•ã€‚</p>`;
                    case 'ä¼šè®®è®°å½•':
                        return `<h2>ç¬¬${week}å‘¨ - ${baseName}</h2><p>å›¢é˜Ÿä¼šè®®çºªè¦å’Œè®¨è®ºè¦ç‚¹ã€‚</p>`;
                    case 'è¿›åº¦æŠ¥å‘Š':
                        return `<h2>ç¬¬${week}å‘¨ - ${baseName}</h2><p>é¡¹ç›®è¿›åº¦æ±‡æŠ¥å’Œé‡Œç¨‹ç¢‘è¾¾æˆæƒ…å†µã€‚</p>`;
                }
            }

            return `<h2>ç¬¬${week}å‘¨ - ${baseName}</h2><p>è¿™æ˜¯ç¬¬${week}å‘¨çš„${baseName}æ–‡ä»¶å†…å®¹ã€‚</p>`;
        }

        // åœ¨é€‰æ‹©é¡¹ç›®æˆ–åˆ‡æ¢å‘¨æ•°æ—¶æ›´æ–°ä¾§è¾¹æ æ–‡ä»¶å¤¹ç»“æ„
        function updateSidebarFolderStructure(projectId, week = 1) {
            if (projectId && projectId !== 'æœªé€‰æ‹©é¡¹ç›®') {
                displaySidebarFolderStructure(projectId, week);
            } else {
                document.getElementById('sidebarFolderStructure').innerHTML = '';
            }
        }

        // é‡ç½®å¯¼å…¥è¡¨å•
        function resetImportForm() {
            // æ¸…ç©ºæ‰‹åŠ¨æ·»åŠ çš„æ–‡æ¡£
            manualDocuments = [];
            updateManualDocumentsDisplay();
            console.log('é‡ç½®å¯¼å…¥è¡¨å•');

            // æ¸…ç©ºé¡¹ç›®åç§°
            const projectNameInput = document.getElementById('projectName');
            if (projectNameInput) {
                projectNameInput.value = '';
            }

            // é‡ç½®å‘¨å¼€å§‹æ—¥æœŸä¸ºæœ¬å‘¨ä¸€
            const weekStartDateInput = document.getElementById('weekStartDate');
            if (weekStartDateInput) {
                weekStartDateInput.value = getThisMonday();
            }

            // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.value = '';
            }

            // éšè—æ–‡ä»¶å¤¹ç»“æ„
            hideFolderStructure();

            // é‡ç½®æ–‡ä»¶åç§°æ˜¾ç¤º
            const fileNameElement = document.getElementById('fileName');
            if (fileNameElement) {
                fileNameElement.textContent = 'æœªé€‰æ‹©';
            }
            
            // ç§»é™¤æ‰‹åŠ¨æ–‡æ¡£æ˜¾ç¤ºåŒºåŸŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const manualDocsDisplay = document.getElementById('manualDocumentsDisplay');
            if (manualDocsDisplay) {
                const manualDocsCard = manualDocsDisplay.closest('.card');
                if (manualDocsCard) {
                    manualDocsCard.remove();
                }
            }

            console.log('å¯¼å…¥è¡¨å•å·²é‡ç½®');
        }

        // æ ¼å¼åŒ–é¢„è®¡æ—¶é—´
        function formatEstimatedTime(seconds) {
            if (!seconds || seconds === 0) {
                return '0ç§’';
            }
            if (seconds < 60) {
                return `${Math.ceil(seconds)}ç§’`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.ceil(seconds % 60);
                return `${minutes}åˆ†${secs > 0 ? secs + 'ç§’' : ''}`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}å°æ—¶${minutes > 0 ? minutes + 'åˆ†é’Ÿ' : ''}`;
            }
        }

        // æ›´æ–°å¤„ç†çŠ¶æ€æ˜¾ç¤º
        function updateProcessingStatus(data) {
            console.log('æ›´æ–°å¤„ç†çŠ¶æ€:', data);

            const processedPages = document.getElementById('processedPages');
            const usedTokens = document.getElementById('usedTokens');
            const estimatedTime = document.getElementById('estimatedTime');
            const processingStatus = document.getElementById('processingStatus');

            console.log('DOMå…ƒç´ :', {
                processedPages: !!processedPages,
                usedTokens: !!usedTokens,
                estimatedTime: !!estimatedTime,
                processingStatus: !!processingStatus
            });

            if (processedPages) {
                processedPages.textContent = data.pages || 0;
                console.log('æ›´æ–°æ–‡ä»¶æ•°:', data.pages || 0);
            }
            if (usedTokens) {
                usedTokens.textContent = (data.tokens || 0).toLocaleString();
                console.log('æ›´æ–°tokenæ•°:', data.tokens || 0);
            }
            if (estimatedTime) {
                estimatedTime.textContent = data.estimatedTime || '0ç§’';
                console.log('æ›´æ–°é¢„è®¡æ—¶é—´:', data.estimatedTime || '0ç§’');
            }
            if (processingStatus) {
                processingStatus.textContent = data.status || 'å¤„ç†ä¸­...';
                console.log('æ›´æ–°çŠ¶æ€:', data.status || 'å¤„ç†ä¸­...');
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            isEditMode = false;
            const container = document.querySelector('.container');
            container.classList.remove('edit-mode');

            // åŠ è½½é¡¹ç›®åˆ—è¡¨
            await loadProjects();
        });
    </script>
</body>
</html>
