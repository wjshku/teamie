<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teamie - 项目管理工具</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="container">
        <!-- 左侧导航 -->
        <div class="sidebar">
            <div class="logo">Teamie</div>
            <div class="nav-item" onclick="switchNav('import')">导入项目</div>
            <div class="nav-item active" onclick="switchNav('dashboard')">查看项目进展</div>
            <div class="project-info" id="projectInfo" style="display: none;">
                <span id="currentProject">未选择项目</span><br/>
                <span id="currentPeriod">2025-11-03 至 2025-11-09</span>
                <!-- 文件夹结构显示 -->
                <div id="sidebarFolderStructure" class="sidebar-folder-structure" style="margin-top: 12px;">
                    <!-- 文件夹结构将在这里显示 -->
                </div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="main">
            <div class="header">
                <h2 id="screenTitle">项目进展一览</h2>
                <div class="header-right">
                    <button class="settings-btn" onclick="showModelSettingsDialog()" title="设置AI模型">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    <span id="headerInfo"></span>
                </div>
            </div>

            <div class="content">
                <!-- 屏幕 1: 导入页面 -->
                <div id="screen1" class="screen" style="display: none;">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="switchScreen(1)">导入项目</button>
                    </div>

                    <div class="card">
                        <div class="card-title">选择 Notion HTML 文件夹</div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px;">
                        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                            <p>📁 拖拽文件夹或点击选择</p>
                                <small>选择包含文件的文件夹（支持 html/txt/md 格式，支持子页面）</small>
                                <input type="file" id="fileInput" style="display: none;" webkitdirectory multiple accept=".html,.htm,.txt,.md">
                            </div>
                            <div class="upload-area" onclick="showAddDocumentDialog()" style="cursor: pointer;">
                                <p>📝 手动添加文档</p>
                                <small>点击添加文档，支持复制粘贴内容</small>
                            </div>
                        </div>
                    </div>

                        <div class="grid-2">
                            <div>
                                <div style="display: grid; grid-template-columns: 1fr 200px; gap: 12px; margin-bottom: 8px;">
                                    <label for="projectName" style="display: block; font-size: 12px; font-weight: 600; color: #333;">项目名称</label>
                                    <label id="importModeLabel" style="display: none; font-size: 12px; font-weight: 600; color: #333;">导入模式</label>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: stretch;">
                                    <input type="text" id="projectName" placeholder="输入项目名称" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; height: 42px;">
                                    <div id="importModeFlipCard" style="display: none; perspective: 1000px; width: 200px;">
                                        <div class="flip-card-inner" id="flipCardInner">
                                            <div class="flip-card-front" onclick="flipImportMode()">
                                                <div class="flip-card-content">
                                                    <div style="font-size: 13px; color: #666;">开启新的一周</div>
                                                </div>
                                            </div>
                                            <div class="flip-card-back" onclick="flipImportMode()">
                                                <div class="flip-card-content">
                                                    <div style="font-size: 13px; color: #666;">本周新进展</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" name="importMode" id="importMode" value="new_week">
                            </div>
                            <div>
                                <label for="weekStartDate" style="display: block; font-size: 12px; font-weight: 600; color: #333; margin-bottom: 8px;">本周开始日期（周一）</label>
                                <input type="date" id="weekStartDate" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">已上传文件</div>
                        <!-- 文件夹结构预览 -->
                        <div id="folderStructureCard" style="display: none; margin-top: 16px;">
                            <div id="folderStructure" class="folder-structure">
                                <!-- 文件夹结构将在这里动态生成 -->
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="btn primary" onclick="handleUpload()">上传并分析</button>
                        <button class="btn" onclick="cancelImport()">取消</button>
                    </div>
                </div>

                <!-- 屏幕 2: 分析进行中 -->
                <div id="screen2" class="screen" style="display: none;">
                    <div style="text-align: center; padding: 60px 20px;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <h3 style="margin-bottom: 10px;">处理中...</h3>
                        <p class="text-muted">正在解析您的 Notion 文件夹</p>

                        <div class="card" style="margin-top: 30px; text-align: left;">
                            <div class="data-item">
                                <span class="data-label">符合要求的文件数量</span>
                                <span class="data-value" id="processedPages">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Token数量</span>
                                <span class="data-value" id="usedTokens">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">预计处理时间</span>
                                <span class="data-value" id="estimatedTime">0</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">处理进度</span>
                                <span class="data-value" id="processingStatus">初始化中...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 屏幕 3: 进展汇报 -->
                <div id="screen3" class="screen" style="display: none;">
                    <div class="week-nav">
                        <a onclick="changeWeek(-1)">← 上一周</a>
                        <span class="week-current">第 1 周</span>
                        <a onclick="changeWeek(1)">下一周 →</a>
                        <button class="btn primary" onclick="showImportScreen()">导入新进展</button>
                        <button class="btn" onclick="toggleEditMode()" id="editBtn">编辑内容</button>
                        <button class="btn" onclick="saveAllEdits()" id="saveBtn" style="display: none;">保存修改</button>
                        <button class="btn" onclick="deleteCurrentWeek()" id="deleteWeekBtn" style="display: none; background-color: #dc3545; color: white;">删除该周进展</button>
                        <button class="dimension-toggle-btn" onclick="toggleDimensionControls()">自定义视图</button>
                    </div>

                    <!-- 维度控制 -->
                    <div class="dimension-controls hidden">
                        <button class="dimension-toggle active" data-section="motivation" onclick="toggleDimension(this)">动机与方向</button>
                        <button class="dimension-toggle active" data-section="completed" onclick="toggleDimension(this)">达成事项</button>
                        <button class="dimension-toggle active" data-section="incomplete" onclick="toggleDimension(this)">未达成事项</button>
                        <button class="dimension-toggle" data-section="internal" onclick="toggleDimension(this)">内部反思</button>
                        <button class="dimension-toggle" data-section="external" onclick="toggleDimension(this)">外部反馈</button>
                        <button class="dimension-toggle active" data-section="next-steps" onclick="toggleDimension(this)">下一步计划</button>
                    </div>

                    <!-- Z字型布局：动机与方向 → 完成事项 → 未完成事项 → 内部反馈 → 外部反馈 → 下一步计划 -->
                    <div class="report-flex">
                        <!-- 第一行：动机与方向 -->
                        <div class="report-section" data-section="motivation">
                            <div class="section-title">动机与方向</div>
                            <div id="reasons-list"></div>
                            <div id="feedback-motivation" class="feedback-buttons"></div>
                        </div>

                        <!-- 第二行：达成事项 -->
                        <div class="report-section" data-section="completed">
                            <div class="section-title">达成事项</div>
                            <div id="completed-tasks"></div>
                            <div class="text-muted" id="completed-count" style="padding-top: 8px;"></div>
                            <div id="feedback-completed" class="feedback-buttons"></div>
                        </div>

                        <!-- 第三行：未达成事项 -->
                        <div class="report-section" data-section="incomplete">
                            <div class="section-title">未达成事项</div>
                            <div id="not-completed-tasks"></div>
                            <div class="text-muted" id="not-completed-count" style="padding-top: 8px;"></div>
                            <div id="feedback-incomplete" class="feedback-buttons"></div>
                        </div>

                        <!-- 第四行：内部反思 -->
                        <div class="report-section hidden" data-section="internal">
                            <div class="section-title">内部反思</div>
                            <div id="why-not-list"></div>
                            <div id="feedback-internal" class="feedback-buttons"></div>
                        </div>

                        <!-- 第五行：外部反馈 -->
                        <div class="report-section hidden" data-section="external">
                            <div class="section-title">外部反馈</div>
                            <div id="achievements-list"></div>
                            <div id="feedback-external" class="feedback-buttons"></div>
                        </div>

                        <!-- 第六行：下一步计划 -->
                        <div class="report-section" data-section="next-steps">
                            <div class="section-title">下一步计划</div>
                            <div id="next-steps-list"></div>
                            <div id="feedback-next-steps" class="feedback-buttons"></div>
                        </div>
                    </div>
                </div>

                <!-- 屏幕 4: 项目列表 -->
                <div id="screen4" class="screen active" style="display: block;">
                    <div style="margin-bottom: 16px;">
                        <div id="project-stats" style="font-size: 12px; color: #666;"></div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>项目名称</th>
                                <th>当前周期</th>
                                <th>状态与评价</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="project-list">
                            <!-- 项目数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Dialog容器 -->
    <div id="dialogContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/screens.js"></script>
    <script src="js/projects.js"></script>
    <script src="js/upload.js"></script>
    <script src="js/week-report.js"></script>
</body>
</html>